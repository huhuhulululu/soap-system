---
phase: 10-shared-data-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/icd-catalog.ts
  - src/shared/cpt-catalog.ts
  - frontend/src/views/BatchView.vue
  - frontend/src/data/writer-constants.ts
autonomous: true
requirements: [DATA-01, DATA-02]

must_haves:
  truths:
    - "BatchView.vue has zero inline ICD_CATALOG data — imports from src/shared/icd-catalog.ts"
    - "BatchView.vue has zero inline CPT data (INS_CPT, is99203Ins, defaultCptStr, toggle99203) — imports from src/shared/cpt-catalog.ts"
    - "writer-constants.ts ICD_CATALOG re-exports from src/shared/icd-catalog.ts instead of defining its own 54-entry array"
    - "Frontend ICD catalog gains entries from shared module superset (66 entries vs previous 42/54)"
    - "CPT string output matches existing format exactly (e.g. defaultCptStr('WC') === '97813,97814x2,97811')"
    - "TypeScript compiles with zero errors"
  artifacts:
    - path: "src/shared/icd-catalog.ts"
      provides: "getICDCatalog() adapter returning {icd10, desc, bodyPart, laterality} shape"
      exports: ["getICDCatalog", "ICDCatalogEntry"]
    - path: "src/shared/cpt-catalog.ts"
      provides: "defaultCptStr(), is99203Ins(), toggle99203() helpers"
      exports: ["defaultCptStr", "is99203Ins", "toggle99203"]
    - path: "frontend/src/views/BatchView.vue"
      provides: "BatchView consuming shared ICD/CPT modules"
    - path: "frontend/src/data/writer-constants.ts"
      provides: "ICD_CATALOG re-exported from shared module"
  key_links:
    - from: "frontend/src/views/BatchView.vue"
      to: "src/shared/icd-catalog.ts"
      via: "import { getICDCatalog }"
      pattern: "import.*getICDCatalog.*from.*shared/icd-catalog"
    - from: "frontend/src/views/BatchView.vue"
      to: "src/shared/cpt-catalog.ts"
      via: "import { defaultCptStr, is99203Ins, toggle99203 }"
      pattern: "import.*defaultCptStr.*from.*shared/cpt-catalog"
    - from: "frontend/src/data/writer-constants.ts"
      to: "src/shared/icd-catalog.ts"
      via: "import { getICDCatalog }"
      pattern: "import.*getICDCatalog.*from.*shared/icd-catalog"
    - from: "src/shared/ (backend)"
      to: "src/shared/icd-catalog.ts"
      via: "Backend already imports directly — no inline copies exist outside src/shared/"
      pattern: "getAllICDEntries|getICDName|getICDEntry"
---

<objective>
Extract ICD catalog and CPT defaults from BatchView.vue inline data to shared modules, and update writer-constants.ts to re-export from the same shared source.

Purpose: Eliminate three copies of ICD data (shared 66, writer-constants 54, BatchView 42) and two copies of CPT logic, establishing src/shared/ as the single source of truth for both frontend and backend.

Output: Shared adapter functions in icd-catalog.ts and cpt-catalog.ts; BatchView.vue and writer-constants.ts importing from shared instead of defining inline data.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-shared-data-extraction/10-RESEARCH.md
@src/shared/icd-catalog.ts
@src/shared/cpt-catalog.ts
@frontend/src/views/BatchView.vue
@frontend/src/data/writer-constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add frontend adapter functions to shared modules</name>
  <files>src/shared/icd-catalog.ts, src/shared/cpt-catalog.ts</files>
  <action>
**icd-catalog.ts** — Add adapter interface and function at the bottom of the file:

```typescript
export interface ICDCatalogEntry {
  readonly icd10: string
  readonly desc: string
  readonly bodyPart: string | null
  readonly laterality: string | null
}

export function getICDCatalog(): readonly ICDCatalogEntry[] {
  return ICD_ENTRIES.map(e => ({ icd10: e.code, desc: e.name, bodyPart: e.bodyPart, laterality: e.laterality }))
}
```

This maps the canonical `{code, name}` schema to the frontend-expected `{icd10, desc}` schema. Do NOT rename existing fields — backend depends on `{code, name}`.

**Backend decision (locked: "后端也改为从共享模块导入"):** Already satisfied — no backend file outside `src/shared/` has inline ICD/CPT data. Backend consumers (if any) already import via `getAllICDEntries`/`getICDName` from `src/shared/icd-catalog.ts`. Verify with: `grep -rn "icd-catalog\|cpt-catalog" src/ --include="*.ts" | grep -v __tests__ | grep -v src/shared/` — must return zero matches.

**cpt-catalog.ts** — Add three helper functions at the bottom of the file:

```typescript
export function defaultCptStr(insurance: InsuranceType): string {
  return getDefaultTXCPT(insurance)
    .map(e => e.units > 1 ? `${e.code}x${e.units}` : e.code)
    .join(',')
}

export function is99203Ins(insurance: InsuranceType): boolean {
  return getDefaultIECPT(insurance).length > 0
}

export function toggle99203(cpt: string, insurance: InsuranceType): string {
  const base = defaultCptStr(insurance)
  return cpt.includes('99203') ? base : `${base},99203`
}
```

**Verify CPT string equivalence** before proceeding:
- `defaultCptStr('HF')` must equal `'97810'`
- `defaultCptStr('WC')` must equal `'97813,97814x2,97811'`
- `defaultCptStr('VC')` must equal `'97813,97814,97811x2'`
- `is99203Ins('HF')` must be `true`, `is99203Ins('WC')` must be `false`
  </action>
  <verify>Run `npx tsc --noEmit` from project root — zero errors. Verify ICD entry count: `node -e "const m=require('./src/shared/icd-catalog');console.log(m.getICDCatalog().length)"` must print `66`. Manually trace defaultCptStr output against BatchView.vue INS_CPT values to confirm exact match.</verify>
  <done>icd-catalog.ts exports getICDCatalog() and ICDCatalogEntry; cpt-catalog.ts exports defaultCptStr(), is99203Ins(), toggle99203(); TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline data in BatchView.vue and writer-constants.ts with shared imports</name>
  <files>frontend/src/views/BatchView.vue, frontend/src/data/writer-constants.ts</files>
  <action>
**BatchView.vue** — In the `<script setup>` section:

1. Add imports at the top:
```typescript
import { getICDCatalog } from '../../../../src/shared/icd-catalog'
import { defaultCptStr, is99203Ins, toggle99203 } from '../../../../src/shared/cpt-catalog'
```

2. Replace the inline `ICD_CATALOG` array (~line 81, approximately 50 lines of array literal) with:
```typescript
const ICD_CATALOG = getICDCatalog()
```

3. Delete the inline CPT block (~lines 152-159):
   - `const INS_CPT = { ... }` — DELETE
   - `function is99203Ins(ins) { ... }` — DELETE
   - `function defaultCptStr(ins) { ... }` — DELETE
   - `function toggle99203(cpt, ins) { ... }` — DELETE

4. Verify template references still work: `ICD_CATALOG.filter(...)`, `defaultCptStr(...)`, `is99203Ins(...)`, `toggle99203(...)` — these names are unchanged so template code needs no changes.

**writer-constants.ts** — Replace the inline 54-entry ICD_CATALOG array:

1. Add import at the top:
```typescript
import { getICDCatalog } from '../../../src/shared/icd-catalog'
```

2. Replace the `export const ICD_CATALOG = [ ... ]` array literal with:
```typescript
export const ICD_CATALOG = getICDCatalog()
```

3. Remove the `as const` assertion if present — `getICDCatalog()` returns `readonly` array which is sufficient.

**Import path verification:** The `../../../../src/shared/` pattern is already established in the codebase (see `useSOAPGeneration.ts` and `WriterPanel.vue`). Use the same relative path depth.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Run `cd frontend && npx vue-tsc --noEmit` if available, otherwise `npx tsc --noEmit` from root. Grep for any remaining inline ICD/CPT data: `grep -n "INS_CPT\|const ICD_CATALOG = \[" frontend/src/views/BatchView.vue frontend/src/data/writer-constants.ts` should return zero matches.</verify>
  <done>BatchView.vue imports ICD_CATALOG from shared/icd-catalog and CPT helpers from shared/cpt-catalog; writer-constants.ts re-exports ICD_CATALOG from shared; zero inline ICD/CPT data remains in either file; TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `grep -rn "const ICD_CATALOG = \[" frontend/src/` — zero matches (no inline arrays remain)
3. `grep -rn "const INS_CPT" frontend/src/` — zero matches
4. `grep -rn "getICDCatalog\|defaultCptStr\|is99203Ins\|toggle99203" frontend/src/` — confirms imports exist in BatchView.vue and writer-constants.ts
5. `grep -rn "getICDCatalog\|defaultCptStr\|is99203Ins\|toggle99203" src/shared/` — confirms exports exist in shared modules
</verification>

<success_criteria>
- ICD data has ONE source of truth: src/shared/icd-catalog.ts (66 entries)
- CPT logic has ONE source of truth: src/shared/cpt-catalog.ts
- BatchView.vue and writer-constants.ts import from shared — zero inline data
- All existing template references (ICD_CATALOG.filter, defaultCptStr, is99203Ins, toggle99203) work unchanged
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-shared-data-extraction/10-01-SUMMARY.md`
</output>
