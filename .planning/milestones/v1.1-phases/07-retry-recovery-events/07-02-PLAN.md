---
phase: 07-retry-recovery-events
plan: "02"
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - server/services/automation-runner.ts
autonomous: true
requirements: [OBS-01]

must_haves:
  truths:
    - "Parent process detects JSON lines from stdout and stores them as structured events"
    - "Non-JSON stdout lines continue to be appended as plain log strings"
    - "AutomationJob exposes an events array for API consumers"
  artifacts:
    - path: "server/services/automation-runner.ts"
      provides: "JSON event parsing from child stdout"
      contains: "BatchEvent"
  key_links:
    - from: "server/services/automation-runner.ts"
      to: "server/services/automation-types.ts"
      via: "import BatchEvent"
      pattern: "import.*BatchEvent.*automation-types"
---

<objective>
Parse structured NDJSON events from child process stdout in the parent automation runner.

Purpose: Enable real-time event consumption and post-analysis by storing parsed BatchEvent objects separately from plain log lines.
Output: Updated automation-runner.ts with JSON detection in stdout handler and events field on AutomationJob.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-retry-recovery-events/07-01-SUMMARY.md
@server/services/automation-runner.ts
@server/services/automation-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add events field and JSON parsing to automation-runner.ts</name>
  <files>server/services/automation-runner.ts</files>
  <action>
Three targeted changes:

1. **Import BatchEvent** from `./automation-types` (add to existing imports or create new import).

2. **Add `events` field** to `AutomationJob` interface and the internal `currentJob` shape:
   - `AutomationJob`: add `readonly events: readonly BatchEvent[]`
   - Internal `currentJob` type: add `events: BatchEvent[]`
   - Initialize `events: []` when creating a new job in `startAutomation()`
   - Include `events: currentJob.events` in all places that return `AutomationJob` objects (`getJobStatus`, `getActiveJob`, `startAutomation` return)

3. **Update `child.stdout?.on('data')` handler** (lines 218-223) to detect JSON lines:
   - For each line, check if it starts with `{`
   - If yes, try `JSON.parse(line) as BatchEvent` and push to `currentJob.events`
   - On parse failure, fall through to `appendLog(line)` as before
   - Always call `appendLog(line)` regardless (events are also logged for debug visibility)

Pattern from research:
```typescript
if (line.startsWith('{')) {
  try {
    const event = JSON.parse(line) as BatchEvent
    if (currentJob) currentJob.events.push(event)
  } catch { /* malformed — treat as plain log */ }
}
appendLog(line)
```
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Grep for `BatchEvent` in automation-runner.ts — must exist.
Grep for `events` in automation-runner.ts — must appear in AutomationJob interface and stdout handler.
  </verify>
  <done>
Parent process parses JSON lines from child stdout into BatchEvent objects.
AutomationJob.events array available for API consumers.
Non-JSON lines still logged normally.
TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -n 'BatchEvent\|\.events' server/services/automation-runner.ts` shows import, type usage, and event storage
3. stdout handler has JSON detection logic with try/catch fallback
</verification>

<success_criteria>
- JSON lines from child stdout parsed and stored in AutomationJob.events
- Plain log lines unaffected
- BatchEvent type imported from automation-types
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-retry-recovery-events/07-02-SUMMARY.md`
</output>
