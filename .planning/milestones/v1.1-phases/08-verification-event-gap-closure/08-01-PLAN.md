---
phase: 08-verification-event-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/__tests__/automation-types.test.ts
  - scripts/playwright/mdland-automation.ts
autonomous: true
requirements:
  - ERR-01
  - ERR-02
gap_closure: true

must_haves:
  truths:
    - "classifyError() returns 'session_expired' for session expired errors"
    - "classifyError() returns 'timeout' for TimeoutError"
    - "classifyError() returns 'unknown' for unrecognized errors"
    - "isPermanentError() returns true for session_expired, patient_not_found, visit_not_found"
    - "isPermanentError() returns false for timeout, element_not_found, unknown"
    - "failedStep is assigned from currentStep in processVisit catch block"
    - "Pre-batch session expiry emits batch_summary with aborted:true before process.exit(1)"
  artifacts:
    - path: "server/__tests__/automation-types.test.ts"
      provides: "Unit tests for classifyError and isPermanentError"
      contains: "classifyError"
    - path: "scripts/playwright/mdland-automation.ts"
      provides: "emitEvent call before pre-batch process.exit(1)"
      contains: "emitEvent"
  key_links:
    - from: "server/__tests__/automation-types.test.ts"
      to: "server/services/automation-types.ts"
      via: "import { classifyError, isPermanentError }"
      pattern: "import.*classifyError.*isPermanentError.*automation-types"
---

<objective>
Close ERR-01 and ERR-02 audit gaps: add unit tests proving classifyError() and isPermanentError() correctness, verify failedStep population via static check, and fix pre-batch session expiry event emission.

Purpose: These requirements were implemented in Phase 5 but never verified with tests. The pre-batch session expiry path also silently exits without emitting a batch_summary event.
Output: Passing test suite for error classification + fixed event emission in main()
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-verification-event-gap-closure/8-RESEARCH.md
@server/services/automation-types.ts
@scripts/playwright/mdland-automation.ts
@server/__tests__/batch-store.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for classifyError and isPermanentError (ERR-01)</name>
  <files>server/__tests__/automation-types.test.ts</files>
  <action>
Create `server/__tests__/automation-types.test.ts` with vitest tests covering all branches of `classifyError()` and `isPermanentError()`.

classifyError test cases:
- Permanent: `new Error('session expired')` -> 'session_expired'
- Permanent: `new Error('Patient not found')` -> 'patient_not_found'
- Permanent: `new Error('Visit #3 not found')` -> 'visit_not_found'
- Transient: Error with `name='TimeoutError'` -> 'timeout'
- Transient: `new Error('timeout waiting for selector')` -> 'timeout' (message-based)
- Transient: `new Error('element not found')` -> 'element_not_found'
- Transient: `new Error('not accessible')` -> 'element_not_found'
- Fallback: `new Error('unexpected crash')` -> 'unknown'
- Fallback: raw string `'raw string error'` -> 'unknown'
- Case insensitivity: `new Error('SESSION EXPIRED')` -> 'session_expired'

isPermanentError test cases:
- true for: 'session_expired', 'patient_not_found', 'visit_not_found'
- false for: 'timeout', 'element_not_found', 'unknown'

Import from `../services/automation-types`. Follow existing test patterns in `server/__tests__/`.
  </action>
  <verify>Run `cd server && npx vitest run __tests__/automation-types.test.ts` — all tests pass</verify>
  <done>All classifyError branches and isPermanentError return values verified by passing tests</done>
</task>

<task type="auto">
  <name>Task 2: Pre-batch session expiry event emission + ERR-02 static verification</name>
  <files>scripts/playwright/mdland-automation.ts</files>
  <action>
In `scripts/playwright/mdland-automation.ts` `main()` function (~L1393-1396), add an `emitEvent()` call before `process.exit(1)` when `validateSession()` returns false.

Current code:
```
if (!valid) {
  console.error('\nSession expired. Please re-run extract-cookies.ts');
  process.exit(1);
}
```

Change to:
```
if (!valid) {
  console.error('\nSession expired. Please re-run extract-cookies.ts');
  emitEvent({
    type: 'batch_summary',
    total: 0, passed: 0, failed: 0, skipped: batchData.summary.totalVisits,
    durationMs: 0,
    aborted: true,
    abortReason: 'session_expired',
    failures: [],
    ts: Date.now(),
  });
  process.exit(1);
}
```

`emitEvent` is a module-level function (L173) — no import needed. `batchData` is loaded before `validateSession()` (L1371) — `batchData.summary.totalVisits` is available.

ERR-02 static verification: confirm `failedStep: currentStep` exists in the processVisit catch return. This was verified in Phase 5 (05-01-SUMMARY.md) and confirmed in 8-RESEARCH.md L1165. No code change needed — just verify the pattern is still present via grep.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -n 'failedStep: currentStep' scripts/playwright/mdland-automation.ts` returns a match (ERR-02 static verification)
3. `grep -A5 'Session expired.*re-run' scripts/playwright/mdland-automation.ts` shows emitEvent call before process.exit(1)
  </verify>
  <done>Pre-batch session expiry emits batch_summary(aborted:true) before exit; failedStep assignment confirmed present in processVisit catch</done>
</task>

</tasks>

<verification>
1. `cd server && npx vitest run __tests__/automation-types.test.ts` — all tests pass
2. `npx tsc --noEmit` — zero errors across project
3. `grep 'failedStep: currentStep' scripts/playwright/mdland-automation.ts` — match found
4. `grep -B2 'process.exit(1)' scripts/playwright/mdland-automation.ts` — emitEvent precedes exit
</verification>

<success_criteria>
- ERR-01: classifyError() correctness proven by passing unit tests covering all 6 error kinds + edge cases
- ERR-02: failedStep population confirmed via static grep check (runtime test infeasible without Playwright mocking)
- Pre-batch session expiry emits batch_summary event with aborted:true before process.exit(1)
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-verification-event-gap-closure/08-01-SUMMARY.md`
</output>
