---
phase: 04-security-hardening-stability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/index.ts
autonomous: true
requirements: [SEC-2, SEC-3]

must_haves:
  truths:
    - "All POST/PUT/PATCH/DELETE requests require matching CSRF cookie and header"
    - "CSRF failure returns 403 with generic error (no detail leaked)"
    - "API-key clients are NOT exempt from CSRF (locked decision)"
    - "Production startup fails fast if SHARED_JWT_SECRET or COOKIE_ENCRYPTION_KEY missing"
    - "Dev mode starts without env vars (no crash, no warning)"
    - "Tests calling createApp() are unaffected by env validation"
  artifacts:
    - path: "server/index.ts"
      provides: "CSRF middleware + env validation"
      contains: "csrfProtect"
  key_links:
    - from: "server/index.ts csrfProtect"
      to: "cookie-parser"
      via: "req.cookies.csrf_token read"
      pattern: "req\\.cookies\\.csrf_token"
    - from: "server/index.ts validateEnv"
      to: "require.main === module block"
      via: "called before createApp()"
      pattern: "validateEnv"
---

<objective>
Add CSRF protection via double-submit cookie and fail-fast env validation on production startup.

Purpose: Prevent cross-site request forgery on all state-changing endpoints and ensure production never runs without required secrets.
Output: server/index.ts updated with two new functions — no new dependencies.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-security-hardening-stability/04-RESEARCH.md
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CSRF double-submit cookie middleware</name>
  <files>server/index.ts</files>
  <action>
1. Add `import { randomBytes } from 'crypto'` at the top of the file.

2. Add two functions after the `requireAuth` function and before `createApp()`:

```typescript
function generateCsrfToken(): string {
  return randomBytes(32).toString('hex')
}

function csrfProtect(req: Request, res: Response, next: NextFunction): void {
  if (!req.cookies.csrf_token) {
    res.cookie('csrf_token', generateCsrfToken(), {
      sameSite: 'strict',
      secure: process.env.NODE_ENV === 'production',
    })
  }
  if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(req.method)) {
    const cookieToken = req.cookies.csrf_token as string | undefined
    const headerToken = req.headers['x-csrf-token'] as string | undefined
    if (!cookieToken || cookieToken !== headerToken) {
      res.status(403).json({ success: false, error: 'Forbidden' })
      return
    }
  }
  next()
}
```

3. In `createApp()`, register `app.use(csrfProtect)` AFTER `app.use(cookieParser())` and BEFORE the health check and protected routes. Place it right after the rate limiter registrations (after line 72 area).

Key decisions per locked requirements:
- NO exemptions for x-api-key clients — csrfProtect runs on ALL requests
- CSRF failure returns generic `{ success: false, error: 'Forbidden' }` — no detail
- Cookie is `HttpOnly: false` (omitted = default false) so client JS can read it for the header echo
- `SameSite: strict` is the primary CSRF defense layer
- `Secure: true` only in production (behind nginx HTTPS)
- No token rotation — reuse existing token per cookie lifetime
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Grep for `csrfProtect` in server/index.ts — should appear in function definition and `app.use()` call.
  </verify>
  <done>
All state-changing requests (POST/PUT/PATCH/DELETE) require x-csrf-token header matching csrf_token cookie. No exemptions. Failure returns 403 with generic message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add production env validation at startup</name>
  <files>server/index.ts</files>
  <action>
1. Add a `validateEnv()` function near the other utility functions (after csrfProtect, before createApp):

```typescript
function validateEnv(): void {
  if (process.env.NODE_ENV !== 'production') return
  const required = ['SHARED_JWT_SECRET', 'COOKIE_ENCRYPTION_KEY'] as const
  const missing = required.filter(v => !process.env[v])
  if (missing.length > 0) {
    process.stderr.write(`FATAL: Missing required env vars: ${missing.join(', ')}\n`)
    process.exit(1)
  }
}
```

2. In the `if (require.main === module)` block, call `validateEnv()` BEFORE `createApp()` — it must be the first line in that block:

```typescript
if (require.main === module) {
  validateEnv()
  const port = parseInt(process.env.PORT ?? '3001', 10)
  const app = createApp()
  // ...
}
```

CRITICAL: Do NOT put validateEnv inside createApp(). Tests call createApp() without env vars — putting it there would break the test suite.

Dev mode behavior: `validateEnv()` returns immediately when NODE_ENV !== 'production'. No warning, no crash — dev runs without secrets.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Grep for `validateEnv` in server/index.ts — should appear in function definition and require.main block.
  </verify>
  <done>
Production startup exits with FATAL message if SHARED_JWT_SECRET or COOKIE_ENCRYPTION_KEY missing. Dev mode unaffected. Tests unaffected (createApp() has no env check).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `grep -n "csrfProtect" server/index.ts` shows function + app.use registration
3. `grep -n "validateEnv" server/index.ts` shows function + call in require.main block
4. `grep -n "randomBytes" server/index.ts` confirms crypto import
5. validateEnv is NOT inside createApp (grep confirms it's in require.main block only)
</verification>

<success_criteria>
- CSRF middleware registered before protected routes
- All POST/PUT/PATCH/DELETE require matching cookie+header token
- No API-key exemption from CSRF
- 403 response has no detail beyond "Forbidden"
- Production exits on missing SHARED_JWT_SECRET or COOKIE_ENCRYPTION_KEY
- Dev mode starts without env vars
- createApp() has no env validation (tests safe)
- TypeScript compiles with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-hardening-stability/04-02-SUMMARY.md`
</output>
