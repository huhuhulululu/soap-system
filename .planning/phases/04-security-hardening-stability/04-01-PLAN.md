---
phase: 04-security-hardening-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/batch.ts
  - src/shared/field-parsers.ts
  - src/auditor/layer1/index.ts
autonomous: true
requirements: [SEC-1, BUG-1, BUG-2]

must_haves:
  truths:
    - "Uploading a non-Excel file (e.g. renamed .txt) returns 400 before parsing"
    - "Uploading a file >5MB is rejected by multer"
    - "extractPainCurrent never uses `as any` — uses type guard on unknown"
    - "extractPainCurrent logs warning via stderr on fallback path"
    - "Auditor layer1 uses ?? instead of || for options defaults"
  artifacts:
    - path: "server/routes/batch.ts"
      provides: "Magic bytes validation + 5MB limit"
      contains: "isValidExcelBuffer"
    - path: "src/shared/field-parsers.ts"
      provides: "Type-safe pain parser with warning"
      contains: "Record<string, unknown>"
    - path: "src/auditor/layer1/index.ts"
      provides: "Nullish coalescing defaults"
      contains: "?? []"
  key_links:
    - from: "server/routes/batch.ts"
      to: "multer upload"
      via: "fileSize limit in multer config"
      pattern: "5 \\* 1024 \\* 1024"
    - from: "server/routes/batch.ts"
      to: "route handler"
      via: "magic bytes check after req.file"
      pattern: "isValidExcelBuffer"
---

<objective>
Harden Excel upload validation and fix two type-safety bugs.

Purpose: Prevent malicious file uploads disguised as Excel, reduce multer limit to 5MB, eliminate `as any` in pain parser, and fix semantic correctness in auditor defaults.
Output: Three files updated with targeted fixes — no new dependencies.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-security-hardening-stability/04-RESEARCH.md
@server/routes/batch.ts
@src/shared/field-parsers.ts
@src/auditor/layer1/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add magic bytes validation and reduce upload limit to 5MB</name>
  <files>server/routes/batch.ts</files>
  <action>
1. Change multer `limits.fileSize` from `10 * 1024 * 1024` to `5 * 1024 * 1024` (locked decision: 5MB).

2. Add a pure function `isValidExcelBuffer(buf: Buffer): boolean` above `createBatchRouter()`:
   - Return false if `buf.length < 4`
   - Compare first 4 bytes against XLSX magic (`0x50, 0x4B, 0x03, 0x04`) and XLS magic (`0xD0, 0xCF, 0x11, 0xE0`)
   - Return true if either matches
   - Define magic byte constants as module-level `const` Buffers

3. In the `POST /` handler, after the `if (!req.file)` check and before the mode/Excel parsing logic, add:
   ```typescript
   if (!isValidExcelBuffer(req.file.buffer)) {
     res.status(400).json({ success: false, error: 'Invalid file format' })
     return
   }
   ```

IMPORTANT: Magic bytes check MUST be in the route handler (not multer fileFilter) because fileFilter does not have access to the buffer. Keep the existing fileFilter extension check as a first-pass filter.

Keep .xls support (include XLS_MAGIC) per research recommendation — existing users may have .xls files.
  </action>
  <verify>
Run `npx tsc --noEmit` — no new type errors. Visually confirm the 5MB limit and magic bytes check are in place.
  </verify>
  <done>
Multer limit is 5MB. Non-Excel binary content (wrong magic bytes) returns 400 before reaching parseExcelBuffer. Extension filter still rejects non-.xlsx/.xls filenames.
  </done>
</task>

<task type="auto">
  <name>Task 2: Type-safe pain parser and auditor nullish coalescing</name>
  <files>src/shared/field-parsers.ts, src/auditor/layer1/index.ts</files>
  <action>
**BUG-1 — field-parsers.ts `extractPainCurrent`:**

Replace the current implementation (lines 29-37) with a type-safe version:
1. Remove `as Record<string, any>` cast (line 30)
2. Add guard: if `!painScale || typeof painScale !== 'object'` → call `warnFallback('not an object')` and return its result
3. Cast to `Record<string, unknown>` (not `any`) after the guard
4. Keep existing property checks (`current`, `value`, `range.max`) but use bracket notation with typeof guards
5. Final fallback: `return warnFallback('no recognized key')`

Add a private helper below `extractPainCurrent`:
```typescript
function warnFallback(reason: string): number {
  process.stderr.write(`[field-parsers] extractPainCurrent fallback (${reason}), returning 7\n`)
  return 7
}
```

Use `process.stderr.write` (not `console.warn`) per coding style rules (no console.log statements).

**BUG-2 — auditor/layer1/index.ts lines 55, 76, 97:**

Replace `|| []` with `?? []` on these three lines:
- Line 55: `templateOptions.chronicityLevel?.options ?? []`
- Line 76: `templateOptions.severityLevel?.options ?? []`
- Line 97: `templateOptions.generalCondition?.options ?? []`

This is a 3-character change per line (`||` → `??`). No other changes needed.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Grep for `as any` in field-parsers.ts — should return 0 matches. Grep for `|| []` in auditor/layer1/index.ts — should return 0 matches.
  </verify>
  <done>
`extractPainCurrent` uses `Record<string, unknown>` with proper type guards, logs warning on fallback via stderr. Auditor layer1 uses `?? []` (nullish coalescing) on all three option-default lines.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `grep -n "as any" src/shared/field-parsers.ts` returns nothing
3. `grep -n "|| \[\]" src/auditor/layer1/index.ts` returns nothing
4. `grep -n "5 \* 1024 \* 1024" server/routes/batch.ts` confirms 5MB limit
5. `grep -n "isValidExcelBuffer" server/routes/batch.ts` confirms magic bytes check exists
</verification>

<success_criteria>
- Excel uploads with wrong magic bytes rejected with 400
- Upload size limit is 5MB
- No `as any` in field-parsers.ts
- Pain parser warns on stderr when falling back to default
- Auditor uses `??` not `||` for option defaults
- TypeScript compiles with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-hardening-stability/04-01-SUMMARY.md`
</output>
