---
phase: 11-form-ux-validation
plan: "02"
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - frontend/src/views/BatchView.vue
autonomous: true
requirements:
  - VAL-01

must_haves:
  truths:
    - "Blur on Name shows error if empty"
    - "Blur on DOB shows error if format is invalid"
    - "Selecting Gender/Side clears their error"
    - "Submit is blocked if any required field is empty or invalid"
    - "ICD validation only applies in full mode"
    - "Error messages are specific (DOB shows supported formats)"
  artifacts:
    - path: "frontend/src/views/BatchView.vue"
      provides: "fieldErrors reactive state, validateField, validateAll, error display"
      contains: "fieldErrors"
  key_links:
    - from: "validateField"
      to: "fieldErrors"
      via: "blur handlers populate errors per draft index"
      pattern: "fieldErrors\\.value"
    - from: "validateAll"
      to: "submitDrafts"
      via: "submit guard returns false if errors exist"
      pattern: "validateAll.*submitDrafts"
---

<objective>
Add frontend inline validation — blur-triggered per-field validation and full validation guard on submit.

Purpose: Catch input errors before server round-trip, show specific error messages inline.
Output: Updated BatchView.vue with validation logic and error display.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-form-ux-validation/11-RESEARCH.md
@.planning/phases/11-form-ux-validation/11-CONTEXT.md
@.planning/phases/11-form-ux-validation/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation logic and inline error display</name>
  <files>frontend/src/views/BatchView.vue</files>
  <action>
**Script section changes:**

1. **Add `fieldErrors` ref** near other state refs (after `activeDraft` computed):
   `const fieldErrors = ref({})` — shape: `{ [draftIndex: number]: { name?: string, dob?: string, gender?: string, laterality?: string, insurance?: string, bodyPart?: string, icd?: string } }`

2. **Add `activeErrors` computed**: `computed(() => fieldErrors.value[activeIndex.value] || {})`

3. **Add `validateField(key, value)` function**:
   - Build new errors object by spreading current errors for activeIndex
   - `name`: error if `!value.trim()` → `'Name is required'`, else undefined
   - `dob`: run normalizeDOB(value), error if result doesn't match `/^\d{2}\/\d{2}\/\d{4}$/` → `'Format: MM/DD/YYYY, MM-DD-YYYY, MMDDYYYY, or MM/DD/YY'`, else undefined
   - `gender`: error if `!value` → `'Select gender'`, else undefined
   - `laterality`: error if `!value` → `'Select side'`, else undefined
   - `insurance`: error if `!value` → `'Select insurance'`, else undefined
   - `bodyPart`: error if `!value` → `'Select body part'`, else undefined
   - `icd`: only validate if `(activeDraft.value.mode || batchMode.value) === 'full'` — error if `!value.trim()` → `'At least 1 ICD required in Full mode'`, else undefined
   - Update fieldErrors immutably: `fieldErrors.value = { ...fieldErrors.value, [activeIndex.value]: errors }`

4. **Add `clearFieldError(key)` function**: Remove specific key from activeIndex errors. Used on @input to clear error as user types.

5. **Add `validateAll()` function**: Loop all drafts. For each draft, validate name, dob, gender, laterality, insurance, bodyPart. If `(d.mode || batchMode.value) === 'full'`, also validate icd. Collect all errors into fieldErrors. Return true if no errors across all drafts. If errors found on a different draft than active, switch activeIndex to first draft with errors.

6. **Update `submitDrafts`**: Add `if (!validateAll()) return` as first line before `loading.value = true`.

7. **Update `updateField`**: After the existing logic, call `clearFieldError(key)` to clear error when user changes a field value.

8. **Wire blur handlers**: handleDobBlur already exists from Plan 01. Add `@blur` calls in template for name field. For Gender/Side segmented controls, validation triggers via updateField → clearFieldError, plus validateField on click.

**Template section changes:**

9. **Name input**: Add `@blur="validateField('name', activeDraft.name)"`. Below the input, add error span: `<span v-if="activeErrors.name" class="text-xs text-red-500">{{ activeErrors.name }}</span>`. Add conditional border: `:class="activeErrors.name ? 'border-red-400' : 'border-ink-200'"` on the input.

10. **DOB input**: Update handleDobBlur to also call `validateField('dob', activeDraft.dob)` (research already shows this). Add error span below. Add conditional red border.

11. **Gender segmented control**: Add error span below if `activeErrors.gender`. Add conditional red border on the wrapper div.

12. **Side segmented control**: Same pattern as Gender.

13. **Insurance select**: Add `@blur="validateField('insurance', activeDraft.insurance)"`, error span, conditional border.

14. **BodyPart select**: Add `@blur="validateField('bodyPart', activeDraft.bodyPart)"`, error span, conditional border.

15. **ICD section**: Add error span below ICD tag area if `activeErrors.icd` (only shows in full mode).

Error display pattern: red border (`border-red-400`) on the input/control + small `text-xs text-red-500` message below. Minimal and consistent.
  </action>
  <verify>
1. `grep -n "fieldErrors" frontend/src/views/BatchView.vue` — multiple matches (ref, activeErrors, validateField, template)
2. `grep -n "validateAll" frontend/src/views/BatchView.vue` — at least 2 matches (function def + submitDrafts guard)
3. `grep -n "border-red-400" frontend/src/views/BatchView.vue` — at least 4 matches (name, dob, gender, side)
4. `grep -n "text-red-500" frontend/src/views/BatchView.vue` — at least 4 matches (error messages)
  </verify>
  <done>
- Blur on empty Name shows "Name is required"
- Blur on invalid DOB shows format hint with all 4 supported formats
- Unselected Gender/Side show error on submit
- ICD validation only triggers in full mode
- Submit is blocked with errors displayed, activeIndex switches to first errored draft
- Errors clear as user corrects input
- Error display uses red border + small text below field
  </done>
</task>

</tasks>

<verification>
1. Leave Name empty, tab out — red border + "Name is required" appears
2. Type "abc" in DOB, tab out — red border + format hint appears
3. Type "01152000" in DOB, tab out — formats to 01/15/2000, no error
4. Click Submit with empty Gender — error shown on Gender control
5. Fill all fields, click Submit — no errors, request sent
6. In soap-only mode, leave ICD empty — no ICD error (only required in full mode)
7. Multiple patients: errors on patient 2 switch view to patient 2 on submit
</verification>

<success_criteria>
- All required fields validated on blur and submit
- Specific error messages for each field type
- ICD validation respects mode (full only)
- Submit blocked when validation fails
- Errors clear on user input
- Visual feedback: red border + error text
</success_criteria>

<output>
After completion, create `.planning/phases/11-form-ux-validation/11-02-SUMMARY.md`
</output>
