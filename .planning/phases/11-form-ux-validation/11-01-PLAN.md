---
phase: 11-form-ux-validation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/views/BatchView.vue
autonomous: true
requirements:
  - UX-01
  - UX-02
  - UX-03
  - UX-04

must_haves:
  truths:
    - "Name and DOB are two separate input fields in the form"
    - "DOB auto-formats to MM/DD/YYYY on blur when input matches supported formats"
    - "Gender shows M/F segmented control buttons, not a dropdown"
    - "Side shows L/B/R segmented control buttons, not a dropdown"
    - "Gender and Side have no default value — new patients start unselected"
    - "All 6 fields fit on one row at sm: breakpoint"
    - "Old localStorage drafts with patient field load correctly (migration)"
    - "Submit sends patient string as NAME(MM/DD/YYYY) to server"
  artifacts:
    - path: "frontend/src/views/BatchView.vue"
      provides: "Split Name+DOB fields, segmented controls, compact layout"
      contains: "normalizeDOB"
  key_links:
    - from: "EMPTY_ROW"
      to: "submitDrafts"
      via: "name+dob fields reassembled to patient string"
      pattern: "patient.*name.*dob"
    - from: "loadDrafts"
      to: "EMPTY_ROW"
      via: "migration of old patient field to name+dob"
      pattern: "d\\.patient.*d\\.name"
---

<objective>
Split Patient field into Name + DOB inputs, replace Gender/Side dropdowns with segmented controls, and optimize form layout to single-row compact grid.

Purpose: Improve form UX — faster data entry with dedicated DOB field (auto-format), fewer clicks with toggle buttons, better space utilization.
Output: Updated BatchView.vue with new form controls and layout.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-form-ux-validation/11-RESEARCH.md
@.planning/phases/11-form-ux-validation/11-CONTEXT.md
@.planning/phases/10-shared-data-extraction/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split patient field into name+dob, add segmented controls, update layout</name>
  <files>frontend/src/views/BatchView.vue</files>
  <action>
**Script section changes:**

1. **EMPTY_ROW** (line 29-39): Replace `patient: ''` with `name: '', dob: ''`. Change `gender: 'F'` to `gender: ''` and `laterality: 'B'` to `laterality: ''` (no defaults per locked decision).

2. **Add normalizeDOB function** after EMPTY_ROW. Supports 4 formats → MM/DD/YYYY:
   - MMDDYYYY (8 digits): slice into MM/DD/YYYY
   - MM-DD-YYYY or MM-DD-YY: split on dash, pad, expand 2-digit year with `20` prefix
   - MM/DD/YY: expand 2-digit year with `20` prefix
   - MM/DD/YYYY: pad month/day
   - Unrecognized: return as-is

3. **Add handleDobBlur function**: Call normalizeDOB on activeDraft.dob. If result matches `/^\d{2}\/\d{2}\/\d{4}$/`, call updateField('dob', normalized). This only overwrites if normalization succeeds — partial input is left alone.

4. **loadDrafts** (line 136-148): After `parsed = JSON.parse(saved)`, migrate old drafts. Map each draft: if `d.patient && !d.name`, extract name and dob from patient string using regex `/^(.+?)\((.+?)\)$/` — group 1 is name, group 2 is dob. If no parens match, set name=d.patient, dob=''. Delete the `patient` property from migrated draft. Also ensure `gender` and `laterality` retain their saved values (don't reset to empty — only EMPTY_ROW has empty defaults).

5. **patientLabel** (line 203-205): Change `d.patient` to `d.name`.

6. **patientSummary** (line 207-212): No change needed — it doesn't reference `d.patient`.

7. **submitDrafts** (line 220-238): Before the fetch call, map drafts to add `patient` field: `drafts.value.map(d => ({ ...d, patient: \`\${d.name}(\${d.dob})\` }))`. Use this mapped array as `rows` in the JSON body instead of `drafts.value`.

**Template section changes (Row 1, line 858-887):**

8. **Grid layout**: Change `grid-cols-2 sm:grid-cols-6` to `grid-cols-2 sm:grid-cols-12`.

9. **Replace Patient input** (line 859-862) with two fields:
   - Name field: `sm:col-span-3 col-span-2`, label "Name *", input with `@input="updateField('name', $event.target.value)"`, placeholder "LAST,FIRST"
   - DOB field: `sm:col-span-2 col-span-1`, label "DOB *", input with `@input="updateField('dob', $event.target.value)"` and `@blur="handleDobBlur"`, placeholder "MM/DD/YYYY"

10. **Replace Gender select** (line 863-868) with segmented control: `sm:col-span-1 col-span-1`. Copy the exact pattern from batchMode buttons (line 783-784). Use `v-for="m in [{k:'M',l:'M'},{k:'F',l:'F'}]"`, `@click="updateField('gender', m.k)"`, class condition `activeDraft.gender === m.k ? 'bg-ink-800 text-white' : 'bg-white text-ink-500 hover:bg-paper-100'`. Wrap in `<div class="flex rounded-lg border border-ink-200 overflow-hidden text-xs h-[34px]">` to match input height. Keep the label above.

11. **Insurance select** (line 869-873): Change to `sm:col-span-2`.

12. **BodyPart select** (line 875-880): Change to `sm:col-span-2`.

13. **Replace Side select** (line 881-886) with segmented control: `sm:col-span-2 col-span-1`. Same pattern as Gender but with `[{k:'L',l:'Left'},{k:'B',l:'Bil'},{k:'R',l:'Right'}]` and `activeDraft.laterality === m.k`. Same styling.

Column allocation: Name(3) + DOB(2) + Gender(1) + Insurance(2) + BodyPart(2) + Side(2) = 12.
  </action>
  <verify>
1. `npx tsc --noEmit` — zero errors (or same count as before, since BatchView.vue is .vue not .ts)
2. `grep -n "d\.patient\b" frontend/src/views/BatchView.vue` — should only appear in submitDrafts mapping and loadDrafts migration, NOT in template bindings
3. `grep -n "select.*gender\|select.*laterality" frontend/src/views/BatchView.vue` — zero matches (dropdowns replaced)
4. `grep -n "normalizeDOB" frontend/src/views/BatchView.vue` — at least 2 matches (function def + handleDobBlur call)
5. `grep -n "sm:grid-cols-12" frontend/src/views/BatchView.vue` — at least 1 match
  </verify>
  <done>
- Name and DOB are separate inputs in the form
- Gender shows M/F segmented control (not dropdown)
- Side shows L/B/R segmented control (not dropdown)
- New patients have no default gender or side
- DOB auto-formats on blur
- Row 1 uses 12-column grid with proper proportions
- Old localStorage drafts migrate correctly
- Submit reassembles patient string for server
  </done>
</task>

</tasks>

<verification>
1. Open the app in browser, verify form shows 6 fields on one row (Name, DOB, Gender, Insurance, BodyPart, Side)
2. Type "01152000" in DOB, tab out — should auto-format to "01/15/2000"
3. Type "01-15-00" in DOB, tab out — should auto-format to "01/15/2000"
4. Gender and Side show as button groups, not dropdowns
5. New patient has no gender or side pre-selected
6. Fill form, submit — server receives correct patient string format
7. Reload page — saved drafts load correctly
</verification>

<success_criteria>
- All 6 form fields visible on single row at sm: breakpoint
- DOB normalization works for all 4 input formats
- Gender/Side are segmented controls with ink-800 selected state
- No default values for Gender/Side on new patients
- Submit sends NAME(MM/DD/YYYY) format to server
- localStorage migration handles old patient field format
</success_criteria>

<output>
After completion, create `.planning/phases/11-form-ux-validation/11-01-SUMMARY.md`
</output>
