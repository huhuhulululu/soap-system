---
phase: 12-fixture-snapshots-parity-audit
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/shared/normalize-generation-context.ts
  - server/services/batch-generator.ts
  - frontend/src/composables/useSOAPGeneration.ts
autonomous: true
requirements:
  - PAR-02

must_haves:
  truths:
    - "normalizeGenerationContext() is the sole entry point for building GenerationContext in both batch and compose paths"
    - "Compose user-selected TCM patterns override inference when provided"
    - "Batch path uses inference defaults through the normalizer"
    - "All 30 fixture snapshots from Plan 01 still pass after refactor"
  artifacts:
    - path: "src/shared/normalize-generation-context.ts"
      provides: "Shared normalizer with TCM inference + initialState construction"
      exports: ["normalizeGenerationContext", "NormalizeInput", "NormalizeOutput"]
      min_lines: 60
  key_links:
    - from: "server/services/batch-generator.ts"
      to: "src/shared/normalize-generation-context.ts"
      via: "import normalizeGenerationContext"
      pattern: "import.*normalizeGenerationContext.*from.*normalize-generation-context"
    - from: "frontend/src/composables/useSOAPGeneration.ts"
      to: "src/shared/normalize-generation-context.ts"
      via: "import normalizeGenerationContext"
      pattern: "import.*normalizeGenerationContext.*from.*normalize-generation-context"
    - from: "src/shared/normalize-generation-context.ts"
      to: "src/knowledge/medical-history-engine.ts"
      via: "import inferLocalPatterns, inferSystemicPatterns"
      pattern: "import.*inferLocalPatterns.*from.*medical-history-engine"
---

<objective>
Build `normalizeGenerationContext()` as a shared pure function and refactor both batch-generator.ts and useSOAPGeneration.ts to use it as their sole context-construction entry point.

Purpose: Eliminate the parity gap between compose and batch paths by unifying context construction. The normalizer encapsulates TCM pattern inference + initialState computation (tightness/tenderness/spasm) using a single canonical formula, while allowing compose-side user overrides.

Output: Shared normalizer in `src/shared/`, both generation paths refactored, all 30 existing snapshots still green.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-fixture-snapshots-parity-audit/12-RESEARCH.md
@.planning/phases/12-fixture-snapshots-parity-audit/12-01-SUMMARY.md

@src/shared/normalize-generation-context.ts
@server/services/batch-generator.ts
@frontend/src/composables/useSOAPGeneration.ts
@src/types/index.ts
@src/knowledge/medical-history-engine.ts
@src/generator/tx-sequence-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create normalizeGenerationContext() shared function</name>
  <files>
    src/shared/normalize-generation-context.ts
  </files>
  <action>
Create `src/shared/normalize-generation-context.ts` exporting:

1. `NormalizeInput` interface — accepts all fields needed by both paths:
   - Required: `noteType`, `insuranceType`, `primaryBodyPart`, `laterality`, `painCurrent`
   - Optional with inference: `localPattern`, `systemicPattern` (if omitted, infer via `inferLocalPatterns()`/`inferSystemicPatterns()`)
   - Optional with defaults: `tightness`, `tenderness`, `spasm`, `frequency`, `associatedSymptom`, `painTypes`, `symptomScale`
   - Patient data: `age`, `gender`, `medicalHistory`, `chronicityLevel`, `severityLevel`
   - All other `GenerationContext` fields that either path currently sets

2. `NormalizeOutput` interface — `{ context: GenerationContext, initialState: TXSequenceOptions['initialState'] }`

3. `normalizeGenerationContext(input: NormalizeInput): NormalizeOutput` pure function:
   - TCM inference: call `inferLocalPatterns()` and `inferSystemicPatterns()` as defaults, allow explicit overrides (compose user selections)
   - initialState computation: derive `tightness/tenderness/spasm` from severity using the SAME formula for both paths. Use the `severityToInit` map pattern from RESEARCH.md: `{ severe: 4, 'moderate to severe': 3.5, moderate: 3, 'mild to moderate': 2, mild: 1 }`, then `Math.round()`. Allow explicit overrides.
   - `hasPacemaker`: check `medicalHistory.includes('Pacemaker')`
   - `hasMetalImplant`: check BOTH `'Metal Implant'` AND `'Joint Replacement'` (fixing the compose-side gap identified in RESEARCH.md)
   - Build full `GenerationContext` object with all fields populated
   - Return new objects (immutable pattern per coding style)

CRITICAL: Study the CURRENT `buildContext()` in `batch-generator.ts` and the `generationContext` computed in `useSOAPGeneration.ts` line by line. The normalizer must produce IDENTICAL output to the current batch path for the same inputs — this preserves the 30 fixture snapshots. Any deviation breaks snapshots.

The normalizer unifies the formula, but the BATCH path's current formula is the baseline (snapshots were captured against batch-style generation). So the canonical formula must match batch's current behavior.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/shared/normalize-generation-context.ts` (or full project `npx tsc --noEmit`). The function is a pure function with no side effects. Exports `normalizeGenerationContext`, `NormalizeInput`, `NormalizeOutput`.
  </verify>
  <done>normalizeGenerationContext() exists in src/shared/, compiles cleanly, encapsulates TCM inference + initialState construction, accepts overrides for compose-side user selections.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor batch-generator.ts and useSOAPGeneration.ts to use normalizer</name>
  <files>
    server/services/batch-generator.ts
    frontend/src/composables/useSOAPGeneration.ts
  </files>
  <action>
**batch-generator.ts:**
- Replace the inline `buildContext()` function with a call to `normalizeGenerationContext()` from `src/shared/normalize-generation-context.ts`
- Map `BatchPatient` + `BatchVisit` fields to `NormalizeInput` shape
- Use `output.context` where `buildContext()` result was used
- Use `output.initialState` where the inline `initialState: { pain, tightness, tenderness, spasm, ... }` object was constructed
- Remove the now-redundant `inferLocalPatterns`/`inferSystemicPatterns` imports (they're encapsulated in the normalizer)
- Keep `buildContextFromExtracted`/`buildInitialStateFromExtracted` for the continue-mode path (those use extracted state, not raw patient data)

**useSOAPGeneration.ts:**
- Replace the inline `generationContext` computed property's context construction with a call to `normalizeGenerationContext()`
- Pass user-selected `localPattern`, `systemicPattern` as explicit overrides (these take priority over inference)
- Use `output.initialState` instead of the current inline initialState construction
- This fixes the compose-side gaps: tightness/tenderness/spasm now use the canonical formula, and `hasMetalImplant` now checks both 'Metal Implant' and 'Joint Replacement'

After refactoring both files, run the 30 fixture snapshot tests to confirm they still pass. The batch path must produce byte-identical output because the normalizer uses the same formula. The compose path may now produce DIFFERENT output than before (that's expected and desired — it's being fixed to match batch).

IMPORTANT: Do NOT modify `tx-sequence-engine.ts`, `soap-generator.ts`, or `objective-patch.ts`. Only the context-construction layer changes.
  </action>
  <verify>
1. `npx vitest run src/generator/__fixtures__/fixture-snapshots.test.ts` — all 30 snapshots still pass (batch path unchanged)
2. `npx tsc --noEmit` — zero type errors
3. `grep -r "normalizeGenerationContext" server/services/batch-generator.ts frontend/src/composables/useSOAPGeneration.ts` — both files import and use the normalizer
4. `grep -c "inferLocalPatterns\|inferSystemicPatterns" server/services/batch-generator.ts` — these imports are removed (encapsulated in normalizer)
  </verify>
  <done>Both batch-generator.ts and useSOAPGeneration.ts use normalizeGenerationContext() as their sole context-construction entry point. All 30 fixture snapshots pass. Zero type errors.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/generator/__fixtures__/fixture-snapshots.test.ts` — 30/30 green (regression safety)
2. `npx tsc --noEmit` — 0 errors
3. `grep -rn "normalizeGenerationContext" src/shared/ server/services/ frontend/src/composables/` confirms usage in all 3 locations
4. `normalizeGenerationContext()` is a pure function returning new objects (no mutation)
</verification>

<success_criteria>
- normalizeGenerationContext() is the sole context-construction entry point for both paths
- All 30 fixture snapshots from Plan 01 still pass green
- Zero TypeScript errors
- Compose path now uses canonical tightness/tenderness/spasm formula
</success_criteria>

<output>
After completion, create `.planning/phases/12-fixture-snapshots-parity-audit/12-02-SUMMARY.md`
</output>
