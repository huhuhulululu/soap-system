---
phase: 12-fixture-snapshots-parity-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/generator/__fixtures__/fixture-snapshots.test.ts
  - src/generator/__fixtures__/fixture-data.ts
  - .planning/phases/12-fixture-snapshots-parity-audit/12-AUDIT-REPORT.md
autonomous: true
requirements:
  - AUD-02
  - AUD-01

must_haves:
  truths:
    - "Running vitest against fixture snapshots produces 30/30 green for current engine output"
    - "Strength/ROM values for the same seed+bodyPart are documented across compose, batch, and realistic patch modes"
    - "Audit report marks each comparison as ✅ (consistent) or ❌ (inconsistent)"
  artifacts:
    - path: "src/generator/__fixtures__/fixture-snapshots.test.ts"
      provides: "30 deterministic fixture snapshot tests"
      min_lines: 80
    - path: "src/generator/__fixtures__/fixture-data.ts"
      provides: "30 fixture definitions with seeds, body parts, visit counts"
      min_lines: 60
    - path: ".planning/phases/12-fixture-snapshots-parity-audit/12-AUDIT-REPORT.md"
      provides: "Strength/ROM audit report across compose, batch, realistic patch"
      min_lines: 50
  key_links:
    - from: "src/generator/__fixtures__/fixture-snapshots.test.ts"
      to: "src/generator/soap-generator.ts"
      via: "importexportSOAPAsText and exportTXSeriesAsText"
      pattern: "import.*exportSOAPAsText.*from.*soap-generator"
    - from: "src/generator/__fixtures__/fixture-snapshots.test.ts"
      to: "src/generator/__fixtures__/fixture-data.ts"
      via: "import FIXTURES array"
      pattern: "import.*FIXTURES.*from.*fixture-data"
---

<objective>
Capture 30 regression baseline fixture snapshots of the current SOAP generation engine and produce a Strength/ROM audit report comparing output across compose, batch, and realistic patch modes.

Purpose: Establish a regression safety net before any engine modifications in Phases 13-14. The snapshots lock the current PRNG-deterministic output so any future change that shifts the sequence is immediately detected.

Output: 30 green Vitest snapshot tests + Markdown audit report with ✅/❌ markings.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-fixture-snapshots-parity-audit/12-RESEARCH.md

@src/generator/tx-sequence-engine.ts
@src/generator/soap-generator.ts
@src/generator/objective-patch.ts
@server/services/batch-generator.ts
@frontend/src/composables/useSOAPGeneration.ts
@frontend/src/engine.test.ts
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 30 fixture definitions and snapshot tests</name>
  <files>
    src/generator/__fixtures__/fixture-data.ts
    src/generator/__fixtures__/fixture-snapshots.test.ts
  </files>
  <action>
Create `src/generator/__fixtures__/fixture-data.ts` with a `FIXTURES` array of 30 fixture definitions. Each fixture has: `name`, `bodyPart`, `laterality`, `painCurrent`, `txCount`, `seed`, and optional overrides (`medicalHistory`, `realisticPatch`, `associatedSymptom`).

Distribution (from RESEARCH.md fixture table):
- 7 body parts × 3 visit phases (early 3tx, mid 8-12tx, late 18-20tx) = 21 core fixtures
- 9 edge cases: max pain (10), min pain (3), single visit (1tx), unilateral LBP, high pain + long course, with Pacemaker, with medical history (DM/HTN), realistic patch ON, MIDDLE_BACK
- Seeds: 100001-100030 (unique per fixture)

Create `src/generator/__fixtures__/fixture-snapshots.test.ts`:
- `beforeAll`: call `setWhitelist(whitelistData)` importing from `frontend/src/data/whitelist.json` (established pattern from `engine.test.ts`)
- `makeContext(overrides)` factory function following the pattern in `engine.test.ts` — returns a full `GenerationContext` with sensible defaults
- For each fixture: call `exportTXSeriesAsText(context, { txCount, seed })` (or `exportSOAPAsText` for IE fixtures if any), join visit texts with `\n---VISIT---\n`, assert with `expect(output).toMatchSnapshot()`
- For fixtures with `realisticPatch: true`: apply `patchSOAPText()` to each visit's text before joining
- Use `describe('Fixture Snapshots', () => { for (const fx of FIXTURES) { it(...) } })` loop pattern

IMPORTANT: Do NOT modify any engine files. This captures the CURRENT output as-is. The `__snapshots__/` directory will be auto-generated by Vitest on first run.
  </action>
  <verify>
Run `npx vitest run src/generator/__fixtures__/fixture-snapshots.test.ts --update` to generate initial snapshots, then run `npx vitest run src/generator/__fixtures__/fixture-snapshots.test.ts` (without --update) to confirm all 30 pass deterministically. Both commands should exit 0 with 30 passing tests.
  </verify>
  <done>30 fixture snapshot tests exist and pass green. The `__snapshots__/` directory contains the baseline snapshot file. Re-running without `--update` produces identical results.</done>
</task>

<task type="auto">
  <name>Task 2: Generate Strength/ROM audit report across 3 modes</name>
  <files>
    .planning/phases/12-fixture-snapshots-parity-audit/12-AUDIT-REPORT.md
  </files>
  <action>
Write a temporary audit script (or inline in the test file as a separate `describe` block) that for a representative subset of fixtures (one per body part, 7 total, at mid-visit count ~10-12):

1. **Compose mode**: Build `GenerationContext` the way `useSOAPGeneration.ts` does — omit `tightness/tenderness/spasm` from `initialState`, use explicit `localPattern`/`systemicPattern` values
2. **Batch mode**: Build `GenerationContext` the way `batch-generator.ts` `buildContext()` does — include `tightness/tenderness/spasm` as `painCurrent >= 7 ? 3 : 2`, use `inferLocalPatterns()`/`inferSystemicPatterns()` for TCM
3. **Realistic patch mode**: Same as compose mode but apply `patchSOAPText()` to the output

For each mode, extract from the generated SOAP text:
- Strength values (e.g., "4/5", "4+/5", "5/5")
- ROM values (e.g., "WFL", "limited", percentage values)

Produce `.planning/phases/12-fixture-snapshots-parity-audit/12-AUDIT-REPORT.md` with:
- Header: body part, seed, pain level, tx count
- Table per body part: columns = Mode (Compose/Batch/Realistic Patch), Strength values, ROM values
- Mark each row: ✅ if compose and batch match, ❌ if they differ
- Summary section: total consistent vs inconsistent, list of specific divergence fields

This report documents the CURRENT state of parity gaps before the normalizer is built. It is evidence for AUD-01.
  </action>
  <verify>
The audit report file exists at `.planning/phases/12-fixture-snapshots-parity-audit/12-AUDIT-REPORT.md`. It contains comparison tables for all 7 body parts with ✅/❌ markings. The divergences match the known parity gaps documented in RESEARCH.md (tightness/tenderness/spasm, TCM patterns).
  </verify>
  <done>Audit report exists with full Strength/ROM comparison across compose, batch, and realistic patch modes. Each comparison is marked ✅ or ❌. Known divergences are documented with specific field-level detail.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/generator/__fixtures__/fixture-snapshots.test.ts` exits 0 with 30/30 passing
2. `ls src/generator/__fixtures__/__snapshots__/` shows snapshot file(s)
3. `cat .planning/phases/12-fixture-snapshots-parity-audit/12-AUDIT-REPORT.md` contains ✅/❌ markings
4. No files in `src/generator/` were modified (only new files in `__fixtures__/`)
</verification>

<success_criteria>
- 30 fixture snapshot tests pass green on current engine output
- Audit report documents Strength/ROM consistency across all 3 modes for 7 body parts
- Zero modifications to existing engine files
</success_criteria>

<output>
After completion, create `.planning/phases/12-fixture-snapshots-parity-audit/12-01-SUMMARY.md`
</output>
