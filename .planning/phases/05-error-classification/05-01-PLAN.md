---
phase: 05-error-classification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/automation-types.ts
  - scripts/playwright/mdland-automation.ts
autonomous: true
requirements:
  - ERR-01
  - ERR-02

must_haves:
  truths:
    - "A failed visit result includes the name of the step that failed (e.g. fillSOAP, addICD)"
    - "Each automation error is classified as transient or permanent via classifyError()"
    - "isPermanentError() returns true for session-expired and false for timeout errors"
    - "VisitResult is defined in one place (automation-types.ts) and imported everywhere"
  artifacts:
    - path: "server/services/automation-types.ts"
      provides: "Shared error types, classifyError(), isPermanentError(), VisitResult"
      exports: ["AutomationErrorKind", "VisitResult", "classifyError", "isPermanentError"]
    - path: "scripts/playwright/mdland-automation.ts"
      provides: "currentStep tracking and enriched error returns"
      contains: "currentStep"
  key_links:
    - from: "scripts/playwright/mdland-automation.ts"
      to: "server/services/automation-types.ts"
      via: "import { classifyError, isPermanentError, VisitResult }"
      pattern: "import.*from.*automation-types"
---

<objective>
Create shared error classification types and integrate step-level failure tracking into the automation child process.

Purpose: Foundation for Phase 6 (timeouts reference error kinds) and Phase 7 (retry uses `isPermanentError()` as gate condition). Without this, retry logic cannot distinguish retryable failures from permanent ones.

Output: `automation-types.ts` with shared types; `mdland-automation.ts` with `currentStep` tracking and enriched `VisitResult` returns.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-error-classification/05-RESEARCH.md
@.planning/research/ARCHITECTURE.md
@scripts/playwright/mdland-automation.ts
@server/services/automation-runner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create automation-types.ts with error classification</name>
  <files>server/services/automation-types.ts</files>
  <action>
Create `server/services/automation-types.ts` with:

1. `AutomationErrorKind` — string literal union: `'session_expired' | 'patient_not_found' | 'visit_not_found' | 'timeout' | 'element_not_found' | 'unknown'`

2. `VisitResult` — readonly interface with fields: `patient`, `visitIndex`, `noteType`, `success`, `error?`, `failedStep?`, `errorKind?` (AutomationErrorKind), `duration`, `attempts`

3. `classifyError(err: unknown): AutomationErrorKind` — pure function:
   - `msg.toLowerCase().includes('session expired')` → `'session_expired'`
   - `msg.includes('Patient not found')` → `'patient_not_found'`
   - `msg.includes('Visit #') && msg.includes('not found')` → `'visit_not_found'`
   - `name === 'TimeoutError' || msg.toLowerCase().includes('timeout')` → `'timeout'`
   - `msg.includes('not found') || msg.includes('not accessible')` → `'element_not_found'`
   - fallback → `'unknown'`

4. `isPermanentError(kind: AutomationErrorKind): boolean` — returns true for `session_expired`, `patient_not_found`, `visit_not_found`

Use immutable patterns (readonly interface). No enum — use string union per research recommendation. Order `classifyError` checks so permanent patterns match before transient ones (session_expired before generic 'not found').
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Verify the file exports all 4 symbols.</verify>
  <done>automation-types.ts exists, exports AutomationErrorKind, VisitResult, classifyError, isPermanentError. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate step tracking and error classification into processVisit</name>
  <files>scripts/playwright/mdland-automation.ts</files>
  <action>
Modify `scripts/playwright/mdland-automation.ts`:

1. **Add import** at top: `import { classifyError, type AutomationErrorKind, type VisitResult } from '../../server/services/automation-types.js'`
   - Use `.js` extension for ESM/tsx compatibility per project convention.

2. **Remove local `VisitResult` interface** (L96-103). Replace with the import from step 1. One source of truth.

3. **Add `currentStep` tracking in `processVisit()`** (L1020-1082):
   - Declare `let currentStep = 'init'` after `const start = Date.now()`
   - Before each step call, update `currentStep` to the step name:
     - `'navigateToICD'`, `'addICDCodes'`, `'addCPTCodes'`, `'saveDiagnose'`
     - `'navigateToPTNote'`, `'fillSOAP'`, `'saveSOAP'`
     - `'navigateToCheckout'`, `'generateBilling'`
     - `'closeVisit'`

4. **Enrich success return** (L1054-1060): add `attempts: 1` field.

5. **Enrich error return** (L1073-1080): add `failedStep: currentStep`, `errorKind: classifyError(err)`, `attempts: 1`.

Do NOT change any other logic in processVisit — no retry, no timeout changes, no event emission. Those belong to Phase 6 and 7.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Grep for `failedStep` and `classifyError` in mdland-automation.ts to confirm integration. Grep to confirm no local `VisitResult` interface remains (only the import).</verify>
  <done>processVisit() sets currentStep before each step, returns failedStep + errorKind + attempts on failure, returns attempts: 1 on success. Local VisitResult removed, imported from automation-types.ts.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -n 'failedStep' scripts/playwright/mdland-automation.ts` shows the field in the error return
3. `grep -n 'classifyError' scripts/playwright/mdland-automation.ts` shows the import and usage
4. `grep -n 'interface VisitResult' scripts/playwright/mdland-automation.ts` returns nothing (removed)
5. `grep -n 'export.*VisitResult' server/services/automation-types.ts` confirms single source of truth
6. `grep -n 'isPermanentError' server/services/automation-types.ts` confirms the guard exists
</verification>

<success_criteria>
- TypeScript compiles with zero errors
- VisitResult defined once in automation-types.ts, imported in mdland-automation.ts
- Failed visits include failedStep (step name string) and errorKind (classification)
- isPermanentError() correctly gates session_expired as permanent, timeout as transient
- No behavioral changes to existing automation flow — only enriched return values
</success_criteria>

<output>
After completion, create `.planning/phases/05-error-classification/05-01-SUMMARY.md`
</output>
