---
phase: 07-retry-recovery-events
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/automation-types.ts
  - scripts/playwright/mdland-automation.ts
autonomous: true
requirements: [RET-01, RET-02, ERR-03, OBS-01]

must_haves:
  truths:
    - "A transient-error visit retries up to 2 times with 2s then 4s delays before being marked failed"
    - "Each retry navigates back to the waiting room before re-attempting (page.goto + clickWaitingRoom)"
    - "A session_expired or other permanent error stops the entire batch immediately"
    - "Child process emits NDJSON events on stdout for visit_start, visit_result, and batch_summary"
    - "Retry-exhausted visits are skipped — batch continues to next patient"
    - "Failed patient details include full retry history (each attempt's error)"
    - "Batch summary includes total, passed, failed, skipped counts + duration"
  artifacts:
    - path: "server/services/automation-types.ts"
      provides: "AttemptRecord, BatchEvent types"
      contains: "AttemptRecord"
    - path: "scripts/playwright/mdland-automation.ts"
      provides: "withRetry, emitEvent, fatal-stop logic"
      contains: "withRetry"
  key_links:
    - from: "scripts/playwright/mdland-automation.ts"
      to: "server/services/automation-types.ts"
      via: "import AttemptRecord, BatchEvent"
      pattern: "import.*AttemptRecord.*BatchEvent.*automation-types"
    - from: "scripts/playwright/mdland-automation.ts"
      to: "process.stdout"
      via: "emitEvent writes NDJSON"
      pattern: "process\\.stdout\\.write"
---

<objective>
Add retry logic, fatal-error fast-fail, and NDJSON event emission to the child automation process.

Purpose: Transient failures auto-recover via retry, permanent failures abort immediately, and every visit outcome is emitted as a structured event for parent consumption.
Output: Updated automation-types.ts with event types, updated mdland-automation.ts with withRetry(), emitEvent(), and fatal-stop in processBatch().
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-retry-recovery-events/07-RESEARCH.md
@server/services/automation-types.ts
@scripts/playwright/mdland-automation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AttemptRecord and BatchEvent types to automation-types.ts</name>
  <files>server/services/automation-types.ts</files>
  <action>
Add two new types to the existing file (append after `isPermanentError`):

1. `AttemptRecord` interface — immutable record of a single retry attempt:
   - `readonly attempt: number` (1-indexed)
   - `readonly error: string`
   - `readonly errorKind: AutomationErrorKind`
   - `readonly durationMs: number`

2. `BatchEvent` discriminated union type with 3 variants:
   - `visit_start`: `{ type: 'visit_start', patient: string, visitIndex: number, noteType: string, ts: number }`
   - `visit_result`: `{ type: 'visit_result', patient: string, visitIndex: number, noteType: string, success: boolean, error?: string, errorKind?: AutomationErrorKind, failedStep?: string, duration: number, attempts: number, retryHistory?: ReadonlyArray<AttemptRecord>, ts: number }`
   - `batch_summary`: `{ type: 'batch_summary', total: number, passed: number, failed: number, skipped: number, durationMs: number, aborted: boolean, abortReason?: string, failures: ReadonlyArray<{ patient: string, visitIndex: number, error: string, retryHistory?: ReadonlyArray<AttemptRecord> }>, ts: number }`

All fields readonly. Use `ReadonlyArray` for arrays.

Also add `retryHistory` optional field to the existing `VisitResult` interface:
   - `readonly retryHistory?: ReadonlyArray<AttemptRecord>`
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Grep for `AttemptRecord` and `BatchEvent` in automation-types.ts.</verify>
  <done>AttemptRecord and BatchEvent types exported. VisitResult has optional retryHistory field. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Add withRetry, emitEvent, and fatal-stop to mdland-automation.ts</name>
  <files>scripts/playwright/mdland-automation.ts</files>
  <action>
Three changes to mdland-automation.ts. Import `AttemptRecord` and `BatchEvent` from automation-types (add to existing import).

**Change A — Add `emitEvent()` function** (module-level, after TIMEOUTS block):

```typescript
function emitEvent(event: BatchEvent): void {
  process.stdout.write(JSON.stringify(event) + '\n')
}
```

**Change B — Add `withRetry()` method** to `MDLandAutomation` class (before `processVisit`):

Implements retry with these rules (from locked decisions):
- Max 2 retries (3 total attempts)
- Delays: `[2000, 4000]` (2s then 4s)
- Before each retry: navigate to waiting room via `page.goto('https://web153.b.mdland.net/eClinic/clinic_main.aspx')` then `clickWaitingRoom()` — per locked decision "same tab navigate back to waiting room (page.goto)"
- If `isPermanentError()` returns true on any attempt, stop retrying immediately and return the result
- Accumulate `AttemptRecord[]` for retry history
- Return final `VisitResult` with correct `attempts` count and `retryHistory`
- Treat `unknown` errorKind as retryable (Claude's discretion — safer to retry than skip)

Signature: `async withRetry(patient: PatientData, visit: VisitData, rowNum: number): Promise<VisitResult>`

The method calls `this.openVisit(rowNum)` then `this.processVisit(patient, visit)` for each attempt. On retry, it first does the reset navigation, waits the delay, then re-opens the visit and re-processes.

Note: `processVisit` already calls `closeVisit()` in its catch block, so the reset navigation (page.goto + clickWaitingRoom) handles the "close current visit" requirement. After reset, re-search the patient and re-sort before opening the visit again:
- `this.clickOnePatient()`
- `this.searchPatient(patient.dob)`
- `this.selectPatient(patient.name, patient.dob)`
- `this.sortByApptTime()`
- `this.openVisit(rowNum)`

**Change C — Update `processPatient()` and `processBatch()`:**

In `processPatient()`:
- Replace `const result = await this.processVisit(patient, visit)` with `const result = await this.withRetry(patient, visit, rowNum)`
- Remove the `await this.openVisit(rowNum)` call before it (withRetry handles opening)
- Emit `visit_start` event before calling `withRetry`
- Emit `visit_result` event after `withRetry` returns
- If result has a permanent error, re-throw to propagate to `processBatch()`: `throw new Error(`Fatal: ${result.errorKind}`)` — this lets processBatch catch it

In `processBatch()`:
- Track `batchStart = Date.now()` at the top
- Wrap the patient loop in try/catch for fatal errors
- On fatal catch: emit `batch_summary` with `aborted: true`, then re-throw
- After normal completion: emit `batch_summary` with `aborted: false`
- Remove the existing `console.log` summary block (replaced by emitEvent)
- Batch summary fields: `total` (all results), `passed` (success), `failed` (!success), `skipped` (patients not attempted due to abort = `batchData.summary.totalVisits - allResults.length`), `durationMs` (Date.now() - batchStart), `failures` array with patient/visitIndex/error/retryHistory for each failed result

Do NOT use `console.log` for events — use `process.stdout.write` via `emitEvent()`. Keep existing `console.log` calls for debug output (they go to stdout too but are not JSON-parseable, which is fine — parent detects JSON by `{` prefix).
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors.
Grep for `withRetry` in mdland-automation.ts — must exist.
Grep for `emitEvent` in mdland-automation.ts — must exist.
Grep for `process.stdout.write` in mdland-automation.ts — must exist.
Grep for `isPermanentError` in mdland-automation.ts — must be used in withRetry and/or processPatient.
  </verify>
  <done>
withRetry() retries transient errors up to 2 times with 2s/4s delays, resetting via page.goto + clickWaitingRoom before each retry.
Permanent errors propagate to processBatch() which aborts immediately.
emitEvent() writes NDJSON for visit_start, visit_result, and batch_summary.
Retry-exhausted visits are marked failed and batch continues.
TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -n 'withRetry\|emitEvent\|process\.stdout\.write\|AttemptRecord\|BatchEvent' scripts/playwright/mdland-automation.ts server/services/automation-types.ts` shows all expected symbols
3. `isPermanentError` is called in the retry loop to gate retries
4. No `console.log` used for event emission — only `process.stdout.write`
</verification>

<success_criteria>
- Transient errors trigger retry (up to 2 retries, 2s/4s delays)
- Each retry resets via page.goto to waiting room before re-attempting
- Permanent errors abort the batch immediately
- NDJSON events emitted for visit_start, visit_result, batch_summary
- Retry history captured in VisitResult and batch_summary failures
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-retry-recovery-events/07-01-SUMMARY.md`
</output>
