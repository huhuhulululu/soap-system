# Phase 14, Plan 02: Wire Cumulative Tracking in Engine Loop

**Phase:** 14 — Assessment Reflection
**Requirements:** ASS-02
**Scope:** `tx-sequence-engine.ts` — engine loop caller site only
**Depends on:** 14-01 (deriveAssessmentFromSOA signature expanded)

## Goal

Pass cumulative pain drop and progress from the engine loop into `deriveAssessmentFromSOA()` so the enriched selection logic from 14-01 has the data it needs.

## Pre-Conditions

- [ ] 14-01 complete (deriveAssessmentFromSOA accepts cumulativePainDrop + progress)
- [ ] derive-assessment unit tests pass

## Steps

### Step 1: Write integration test

Create `src/generator/__tests__/assessment-cumulative.test.ts`:

```typescript
import { describe, it, expect } from 'vitest'
import { generateTXSequence } from '../tx-sequence-engine'
import type { GenerationContext } from '../../types'

// Minimal context factory for testing
function makeContext(overrides: Partial<GenerationContext> = {}): GenerationContext {
  return {
    primaryBodyPart: 'KNEE',
    laterality: 'bilateral',
    localPattern: 'Cold-Damp + Wind-Cold',
    systemicPattern: 'Kidney Yang Deficiency',
    chronicityLevel: 'chronic',
    severityLevel: 'moderate to severe',
    insuranceType: 'commercial',
    hasPacemaker: false,
    age: 55,
    medicalHistory: [],
    ...overrides,
  } as GenerationContext
}

describe('Assessment cumulative tracking (ASS-02)', () => {
  it('later visits use stronger assessment language than early visits for same visit-level delta', () => {
    const ctx = makeContext()
    const result = generateTXSequence(ctx, {
      txCount: 12,
      seed: 300001,
    })

    // Visit 2 (early) vs Visit 10 (late) — both should have assessment chain
    const earlyVisit = result.visits[1]  // TX2
    const lateVisit = result.visits[9]   // TX10

    // Late visit should have cumulative evidence → stronger language
    // At minimum, the soaChain.assessment fields should differ
    expect(earlyVisit.soaChain.assessment).toBeDefined()
    expect(lateVisit.soaChain.assessment).toBeDefined()

    // The late visit should not use weaker language than early visit
    // (This is a soft check — exact values depend on PRNG)
  })

  it('assessment whatChanged varies across visits (not identical)', () => {
    const ctx = makeContext()
    const result = generateTXSequence(ctx, {
      txCount: 8,
      seed: 300002,
    })

    const whatChangedSet = new Set(
      result.visits.map(v => v.soaChain.assessment.whatChanged)
    )
    // Should have at least 2 distinct whatChanged values across 8 visits
    expect(whatChangedSet.size).toBeGreaterThanOrEqual(2)
  })
})
```

Run: `npx vitest run src/generator/__tests__/assessment-cumulative.test.ts` — expect RED.

### Step 2: Compute cumulativePainDrop in engine loop

In `tx-sequence-engine.ts`, inside the visit loop (after `painDelta` is computed around line 779), the cumulative drop is trivially available:

```typescript
// ASS-02: cumulative pain drop from IE baseline
const cumulativePainDrop = startPain - painScaleCurrent
```

### Step 3: Pass cumulative params to deriveAssessmentFromSOA

Update the call site (~line 1156):

```typescript
const assessmentFromChain = deriveAssessmentFromSOA({
  painDelta,
  adlDelta,
  frequencyImproved,
  visitIndex: i,
  objectiveTightnessTrend: tightnessTrend,
  objectiveTendernessTrend: tendernessTrend,
  objectiveSpasmTrend: spasmTrend,
  objectiveRomTrend: romTrend,
  objectiveStrengthTrend: strengthTrend,
  // ASS-02: cumulative context
  cumulativePainDrop,
  progress,
})
```

### Step 4: Run integration tests — expect GREEN

Run: `npx vitest run src/generator/__tests__/assessment-cumulative.test.ts`

### Step 5: Run derive-assessment unit tests — still GREEN

Run: `npx vitest run src/generator/__tests__/derive-assessment.test.ts`

### Step 6: Verify rng() call count unchanged

```bash
grep -c "rng()" src/generator/tx-sequence-engine.ts
```

Must match pre-change count.

## Post-Conditions

- [ ] Integration tests pass
- [ ] Unit tests still pass
- [ ] No new rng() calls
- [ ] cumulativePainDrop computed as `startPain - painScaleCurrent`
- [ ] Fixture snapshots will need regeneration (14-03)

## Estimated Duration

~5 minutes
