# Phase 14, Plan 01: Enrich deriveAssessmentFromSOA with Cumulative Context

**Phase:** 14 — Assessment Reflection
**Requirements:** ASS-01, ASS-02, ASS-03
**Scope:** `tx-sequence-engine.ts` — `deriveAssessmentFromSOA()` function only

## Goal

Make `deriveAssessmentFromSOA()` produce evidence-based assessment field selections by:
1. Adding cumulative context params (cumulativePainDrop, progress, totalVisits)
2. Using specific `whatChanged` values based on which metric improved most (ASS-01)
3. Gating `present`/`patientChange` strength on cumulative evidence (ASS-02)
4. All selections from existing TX_*_OPTIONS arrays only (ASS-03)

## Pre-Conditions

- [ ] All 30 fixture snapshots pass: `npx vitest run src/generator/__fixtures__/fixture-snapshots.test.ts`
- [ ] All 9 parity tests pass: `npx vitest run src/generator/__fixtures__/parity-diff.test.ts`

## Steps

### Step 1: Write unit tests for enriched deriveAssessmentFromSOA

Create `src/generator/__tests__/derive-assessment.test.ts`:

```typescript
import { describe, it, expect } from 'vitest'
// Will need to export deriveAssessmentFromSOA for testing
import { deriveAssessmentFromSOA } from '../tx-sequence-engine'

describe('deriveAssessmentFromSOA', () => {
  const baseInput = {
    painDelta: 0.5,
    adlDelta: 0.3,
    frequencyImproved: false,
    visitIndex: 3,
    objectiveTightnessTrend: 'slightly reduced' as const,
    objectiveTendernessTrend: 'stable' as const,
    objectiveSpasmTrend: 'stable' as const,
    objectiveRomTrend: 'slightly improved' as const,
    objectiveStrengthTrend: 'stable' as const,
    // New cumulative params
    cumulativePainDrop: 2.0,
    progress: 0.5,
  }

  describe('ASS-01: specific improvements in whatChanged', () => {
    it('selects "pain frequency" when frequency improved (hard rule preserved)', () => {
      const result = deriveAssessmentFromSOA({ ...baseInput, frequencyImproved: true })
      expect(result.whatChanged).toBe('pain frequency')
    })

    it('selects ADL-related option when adlDelta is dominant', () => {
      const result = deriveAssessmentFromSOA({
        ...baseInput,
        adlDelta: 0.8,
        painDelta: 0.2,
        frequencyImproved: false,
      })
      expect(['difficulty in performing ADLs', 'pain and discomfort', 'symptom severity']).toContain(result.whatChanged)
    })

    it('selects objective-related option when objective trends are strong and pain/adl weak', () => {
      const result = deriveAssessmentFromSOA({
        ...baseInput,
        painDelta: 0.1,
        adlDelta: 0.05,
        frequencyImproved: false,
        objectiveRomTrend: 'improved',
        objectiveTightnessTrend: 'reduced',
      })
      // Should pick a physical-finding-related whatChanged
      expect(['muscles stiffness sensation', 'muscles soreness sensation', 'pain']).toContain(result.whatChanged)
    })
  })

  describe('ASS-02: cumulative progress gates language strength', () => {
    it('uses "improvement" + "decreased" for high cumulative pain drop at late progress', () => {
      const result = deriveAssessmentFromSOA({
        ...baseInput,
        cumulativePainDrop: 4.0,
        progress: 0.75,
        painDelta: 0.3,
      })
      expect(result.present).toBe('improvement of symptom(s).')
      expect(result.patientChange).toBe('decreased')
    })

    it('uses "slight improvement" + "slightly decreased" for low cumulative at early progress', () => {
      const result = deriveAssessmentFromSOA({
        ...baseInput,
        cumulativePainDrop: 0.5,
        progress: 0.15,
        painDelta: 0.3,
      })
      expect(result.present).toBe('slight improvement of symptom(s).')
      expect(result.patientChange).toBe('slightly decreased')
    })

    it('mid-progress with moderate cumulative uses visit-level delta as tiebreaker', () => {
      const result = deriveAssessmentFromSOA({
        ...baseInput,
        cumulativePainDrop: 2.0,
        progress: 0.5,
        painDelta: 0.8,
      })
      // Strong visit-level delta should upgrade to "improvement"
      expect(result.present).toBe('improvement of symptom(s).')
    })
  })

  describe('ASS-03: all values from template options', () => {
    const VALID_PRESENT = [
      'slight improvement of symptom(s).',
      'improvement of symptom(s).',
      'exacerbate of symptom(s).',
      'no change.'
    ]
    const VALID_PATIENT_CHANGE = [
      'decreased', 'slightly decreased', 'increased', 'slight increased', 'remained the same'
    ]
    const VALID_WHAT_CHANGED = [
      'pain', 'pain frequency', 'pain duration', 'numbness sensation',
      'muscles weakness', 'muscles soreness sensation', 'muscles stiffness sensation',
      'heaviness sensation', 'difficulty in performing ADLs', 'as last time visit'
    ]
    const VALID_PHYSICAL_CHANGE = [
      'reduced', 'slightly reduced', 'increased', 'slight increased', 'remained the same'
    ]
    const VALID_FINDING_TYPE = [
      'local muscles tightness', 'local muscles tenderness', 'local muscles spasms',
      'local muscles trigger points', 'joint ROM', 'joint ROM limitation',
      'muscles strength', 'joints swelling', 'last visit'
    ]

    it('all returned values are from valid template options', () => {
      // Test across a range of inputs
      const inputs = [
        baseInput,
        { ...baseInput, painDelta: 0, adlDelta: 0, cumulativePainDrop: 0, progress: 0.1 },
        { ...baseInput, painDelta: 1.5, cumulativePainDrop: 5, progress: 0.9 },
        { ...baseInput, frequencyImproved: true, progress: 0.3 },
      ]
      for (const input of inputs) {
        const result = deriveAssessmentFromSOA(input)
        expect(VALID_PRESENT).toContain(result.present)
        expect(VALID_PATIENT_CHANGE).toContain(result.patientChange)
        expect(VALID_WHAT_CHANGED).toContain(result.whatChanged)
        expect(VALID_PHYSICAL_CHANGE).toContain(result.physicalChange)
        expect(VALID_FINDING_TYPE).toContain(result.findingType)
      }
    })
  })
})
```

Run: `npx vitest run src/generator/__tests__/derive-assessment.test.ts` — expect RED (function not exported, params don't exist yet).

### Step 2: Export deriveAssessmentFromSOA

In `tx-sequence-engine.ts`, change `function deriveAssessmentFromSOA` to `export function deriveAssessmentFromSOA`.

### Step 3: Add cumulative params to deriveAssessmentFromSOA signature

Expand the input type:

```typescript
export function deriveAssessmentFromSOA(input: {
  painDelta: number
  adlDelta: number
  frequencyImproved: boolean
  visitIndex: number
  objectiveTightnessTrend: 'reduced' | 'slightly reduced' | 'stable'
  objectiveTendernessTrend: 'reduced' | 'slightly reduced' | 'stable'
  objectiveSpasmTrend: 'reduced' | 'slightly reduced' | 'stable'
  objectiveRomTrend: 'improved' | 'slightly improved' | 'stable'
  objectiveStrengthTrend: 'improved' | 'slightly improved' | 'stable'
  // ASS-02: cumulative context
  cumulativePainDrop: number  // startPain - currentPain (total from IE baseline)
  progress: number            // 0-1 normalized visit progress
}): { ... }
```

### Step 4: Implement progress-aware `present` and `patientChange` selection (ASS-02)

Replace the current simple threshold logic:

```typescript
// ASS-02: cumulative + visit-level evidence gates language strength
const strongEvidence = input.cumulativePainDrop >= 3.0 && input.progress >= 0.5
const visitLevelStrong = input.painDelta >= 0.7

const present = (strongEvidence || visitLevelStrong)
  ? 'improvement of symptom(s).'
  : 'slight improvement of symptom(s).'

const patientChange = (strongEvidence || visitLevelStrong)
  ? 'decreased'
  : 'slightly decreased'
```

### Step 5: Implement evidence-based `whatChanged` selection (ASS-01)

Replace the current modulo rotation with evidence-based selection:

```typescript
// ASS-01: evidence-based whatChanged selection
// Priority: frequency (hard rule) > ADL > objective > pain (fallback)
const whatChanged = (() => {
  // Hard chain rule preserved: S frequency improved → A must mention "pain frequency"
  if (input.frequencyImproved) return 'pain frequency'

  // Strong ADL improvement → ADL-related option (rotate by visitIndex for variety)
  if (input.adlDelta > 0.2) {
    const adlOptions = ['difficulty in performing ADLs', 'pain and discomfort', 'symptom severity']
    return adlOptions[input.visitIndex % adlOptions.length]
  }

  // Objective findings improved → mention relevant physical metric
  const hasStrongObjective =
    input.objectiveRomTrend === 'improved' ||
    input.objectiveStrengthTrend === 'improved' ||
    input.objectiveTightnessTrend === 'reduced'

  if (hasStrongObjective && input.painDelta < 0.3) {
    const objOptions = ['muscles stiffness sensation', 'muscles soreness sensation']
    return objOptions[input.visitIndex % objOptions.length]
  }

  // Default: pain
  return 'pain'
})()
```

### Step 6: Improve findingType with cumulative awareness (ASS-01)

Update findingType to prefer "joint ROM" over "joint ROM limitation" at late progress:

```typescript
const findingType = (() => {
  if (input.objectiveRomTrend !== 'stable') {
    // Late progress + strong cumulative → "joint ROM" (improvement framing)
    // Early/mid → "joint ROM limitation" (deficit framing)
    return input.progress >= 0.6 && input.cumulativePainDrop >= 2.0
      ? 'joint ROM'
      : 'joint ROM limitation'
  }
  if (input.objectiveStrengthTrend !== 'stable') return 'muscles strength'
  if (input.objectiveTightnessTrend !== 'stable') return 'local muscles tightness'
  if (input.objectiveTendernessTrend !== 'stable') return 'local muscles tenderness'
  if (input.objectiveSpasmTrend !== 'stable') return 'local muscles spasms'
  return 'joint ROM limitation'
})()
```

### Step 7: Run tests — expect GREEN

Run: `npx vitest run src/generator/__tests__/derive-assessment.test.ts`

All tests should pass. Adjust thresholds if needed to match test expectations.

### Step 8: Verify no rng() calls added

```bash
grep -n "rng()" src/generator/tx-sequence-engine.ts | wc -l
```

Count must match pre-change count (no new rng() calls).

## Post-Conditions

- [ ] All derive-assessment unit tests pass
- [ ] No new rng() calls in tx-sequence-engine.ts
- [ ] deriveAssessmentFromSOA is exported
- [ ] Existing fixture/parity tests may fail (expected — assessment text changed; will fix in 14-03)

## Estimated Duration

~8 minutes
