---
phase: 13-recovery-curve-goals-calibration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/generator/goals-calculator.ts
  - src/generator/goals-calculator.test.ts
  - src/generator/soap-generator.ts
autonomous: true
requirements: [CRV-02]

must_haves:
  truths:
    - "Chronic patients (chronicAware=true) get LT pain target reflecting 30-50% improvement, not 75%"
    - "Chronic patients' Strength LT goal never exceeds 4/5"
    - "Chronic patients' ROM LT goal never exceeds 80%"
    - "Non-chronic patients (chronicAware=false or omitted) retain existing goal values unchanged"
    - "calculateDynamicGoals signature is backward compatible (chronicAware is optional, defaults false)"
  artifacts:
    - path: "src/generator/goals-calculator.ts"
      provides: "Chronic-aware caps on pain, strength, ROM goals"
      contains: "CHRONIC_END_RATIO"
    - path: "src/generator/goals-calculator.test.ts"
      provides: "Unit tests for chronic vs non-chronic goal calculation"
      min_lines: 40
    - path: "src/generator/soap-generator.ts"
      provides: "Caller passes chronicAware flag from context.chronicityLevel"
  key_links:
    - from: "src/generator/soap-generator.ts"
      to: "src/generator/goals-calculator.ts"
      via: "calculateDynamicGoals(severity, bp, symptomType, painCurrent, isChronicAware)"
      pattern: "calculateDynamicGoals.*chronicityLevel"
---

<objective>
Add chronic-aware caps to `calculateDynamicGoals` so chronic pain patients get realistic LT targets: 30-50% pain improvement (not 75%), Strength capped at 4/5, ROM capped at 80%.

Purpose: CRV-02 — clinically unrealistic goals undermine SOAP note credibility for chronic patients.
Output: Updated goals-calculator.ts with chronic caps, unit tests, caller update in soap-generator.ts.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-recovery-curve-goals-calibration/13-RESEARCH.md
@src/generator/goals-calculator.ts
@src/generator/soap-generator.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for chronic-aware goals caps</name>
  <files>src/generator/goals-calculator.test.ts</files>
  <action>
Create unit test file for goals-calculator chronic-aware behavior. Test cases:

1. **Pain goals (chronic, pain=8):** `calculateDynamicGoals('moderate to severe', 'LBP', 'soreness', 8, true)` → LT pain target should reflect ~50% improvement (pain ~4-5), NOT 75% (pain ~2).
2. **Pain goals (chronic, pain=10):** `calculateDynamicGoals('severe', 'KNEE', 'soreness', 10, true)` → LT pain target ~5-6, NOT 2-3.
3. **Pain goals (non-chronic, pain=8):** Same call with `chronicAware=false` or omitted → LT pain target ~2-3 (existing behavior unchanged).
4. **Strength goals (chronic):** Chronic → LT strength never exceeds `'4'` (not `'4+'`).
5. **Strength goals (non-chronic):** Non-chronic → LT strength can reach `'4+'` (existing behavior).
6. **ROM goals (chronic, severe):** Chronic → LT ROM ≤ `'70%'` (not `'80%'` or higher).
7. **ROM goals (chronic, moderate to severe):** Chronic → LT ROM ≤ `'80%'`.
8. **ROM goals (non-chronic):** Non-chronic → existing values unchanged.
9. **Backward compatibility:** `calculateDynamicGoals('moderate to severe', 'LBP')` with no 5th arg → same as `chronicAware=false`.

Use `CHRONIC_END_RATIO = 0.55` as the expected ratio for chronic pain LT calculation (pain 8 → LT ceil(8*0.55) = ceil(4.4) = 5).

Run tests — they MUST fail (function doesn't accept chronicAware yet).
  </action>
  <verify>`npx vitest run src/generator/goals-calculator.test.ts` — tests fail because chronicAware parameter doesn't exist yet</verify>
  <done>Test file exists with 9+ test cases covering chronic vs non-chronic goals, all failing</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement chronic-aware caps in goals-calculator + wire caller</name>
  <files>src/generator/goals-calculator.ts, src/generator/soap-generator.ts</files>
  <action>
**goals-calculator.ts changes:**

1. Add constant: `const CHRONIC_END_RATIO = 0.55` (pain 8 → LT ~4-5, 38-50% improvement).

2. Update `calculatePainGoals` signature to accept `chronicAware: boolean = false`. When `chronicAware && painCurrent >= 7`: use `CHRONIC_END_RATIO` instead of `OPTIMAL_END_RATIO` for `optimalEnd` calculation.

3. Update `calculateStrengthGoals` signature to accept `chronicAware: boolean = false`. When `chronicAware`: cap the LT value at 4 (format as `'4'`), ST value at 4 as well. Use immutable patterns — create new return objects, don't mutate.

4. Update `calculateROMGoals` signature to accept `chronicAware: boolean = false`. When `chronicAware`: use a separate chronic ROM map:
   - severe: `{ st: '45%', lt: '60%' }`
   - moderate to severe: `{ st: '55%', lt: '70%' }`
   - moderate: `{ st: '50%', lt: '60%' }`
   - mild to moderate: `{ st: '45%', lt: '55%' }`
   - mild: `{ st: '45%', lt: '55%' }`

5. Update `calculateDynamicGoals` signature: add `chronicAware?: boolean` as 5th parameter (optional, default false). Pass it through to `calculatePainGoals`, `calculateStrengthGoals`, `calculateROMGoals`.

**soap-generator.ts changes:**

6. At L1318, update the `calculateDynamicGoals` call to pass chronic flag:
   ```typescript
   const isChronicAware = context.chronicityLevel === 'Chronic'
   const goals = calculateDynamicGoals(severity, bp, symptomType, context.painCurrent, isChronicAware)
   ```

7. Check for any other `calculateDynamicGoals` call sites and update them similarly if they have access to chronicityLevel.

All changes use immutable patterns. No mutation of existing objects.
  </action>
  <verify>`npx vitest run src/generator/goals-calculator.test.ts` — all tests pass. `npx tsc --noEmit` — zero type errors.</verify>
  <done>Chronic patients get 30-50% LT pain improvement, Strength ≤ 4/5, ROM ≤ 80%. Non-chronic behavior unchanged. Zero type errors.</done>
</task>

</tasks>

<verification>
- `npx vitest run src/generator/goals-calculator.test.ts` — all chronic/non-chronic tests pass
- `npx tsc --noEmit` — zero TypeScript errors
- Manually verify: `calculateDynamicGoals('moderate to severe', 'LBP', 'soreness', 8, true).pain.lt` produces a value ≥ 4 (not 2-3)
- Manually verify: `calculateDynamicGoals('moderate to severe', 'LBP', 'soreness', 8, false).pain.lt` produces existing value (2-3)
</verification>

<success_criteria>
- chronicAware parameter is optional with default false (backward compatible)
- Chronic pain LT target: 30-50% improvement (CHRONIC_END_RATIO = 0.55)
- Chronic Strength LT: capped at 4/5
- Chronic ROM LT: capped at 80% (varies by severity)
- Non-chronic goals: identical to current behavior
- Zero TypeScript errors
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-recovery-curve-goals-calibration/13-01-SUMMARY.md`
</output>
