---
phase: 13-recovery-curve-goals-calibration
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/generator/tx-sequence-engine.ts
  - src/generator/tx-sequence-engine-chronic.test.ts
autonomous: true
requirements: [CRV-01]

must_haves:
  truths:
    - "Patients with txCount ≥ 16 have slower progress curve (chronic dampener 0.82)"
    - "Patients with txCount < 16 have unchanged progress curve"
    - "Engine ltFallback uses CHRONIC_END_RATIO (0.55) when txCount ≥ 16, preserving alignment with goals caps"
    - "No new rng() calls inside the for-loop — PRNG sequence unchanged within loop body"
    - "Chronic dampener is applied BEFORE the loop as a pure multiplication"
  artifacts:
    - path: "src/generator/tx-sequence-engine.ts"
      provides: "Chronic dampener on progressMultiplier + chronic-aware ltFallback"
      contains: "chronicDampener"
    - path: "src/generator/tx-sequence-engine-chronic.test.ts"
      provides: "Unit tests verifying chronic dampener effect on progress and ltFallback"
      min_lines: 40
  key_links:
    - from: "src/generator/tx-sequence-engine.ts"
      to: "progressMultiplier"
      via: "chronicDampener multiplication before loop"
      pattern: "chronicDampener.*txCount.*16"
    - from: "src/generator/tx-sequence-engine.ts"
      to: "ltFallback"
      via: "chronicEndRatio conditional on txCount"
      pattern: "chronicEndRatio.*0\\.55"
---

<objective>
Apply chronic dampener to the TX sequence engine's progress curve for txCount ≥ 16, slowing improvement spread across all 20 visits. Align ltFallback with chronic goals ratio.

Purpose: CRV-01 — chronic patients currently follow the same aggressive S-curve as acute patients, front-loading improvement unrealistically.
Output: Updated tx-sequence-engine.ts with chronic dampener + aligned ltFallback, unit tests proving curve behavior.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-recovery-curve-goals-calibration/13-RESEARCH.md
@src/generator/tx-sequence-engine.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for chronic dampener and ltFallback alignment</name>
  <files>src/generator/tx-sequence-engine-chronic.test.ts</files>
  <action>
Create unit test file that imports `generateTXSequenceStates` and tests chronic dampener behavior.

**CRITICAL PRNG CONSTRAINT:** Tests must use NEW seeds (not 100001-100030 or 200001-200009) to avoid confusion with fixture/parity tests. Use seeds 300001-300005.

Test cases:

1. **Chronic dampener active (txCount=20):** Generate states with txCount=20, seed=300001. Compare visit 10 (midpoint) progress — pain should be higher (less improved) than a txCount=10 run with same seed. Specifically: the chronic run's midpoint pain should be closer to start pain.

2. **Chronic dampener inactive (txCount=12):** Generate states with txCount=12, seed=300002. Compare against txCount=20 run — the txCount=12 run should NOT have dampening applied (txCount < 16).

3. **ltFallback alignment (txCount=20, pain=8):** Generate states with txCount=20, ieStartPain=8, no previousIE. The engine's internal ltFallback should be `ceil(max(2, 8 * 0.55))` = `ceil(4.4)` = 5, NOT `ceil(max(2, 8 * 0.25))` = 2. Verify by checking that the final visit's pain doesn't drop below ~4-5 (it would drop to ~2 without chronic ltFallback).

4. **ltFallback unchanged (txCount=10, pain=8):** Same setup but txCount=10. ltFallback should remain `ceil(max(2, 8 * 0.25))` = 2 (non-chronic behavior).

5. **PRNG sequence preservation:** Generate states with txCount=20, seed=300003. Count the number of visits returned. Verify it equals txCount. This is a sanity check — if rng() calls were added inside the loop, visit count wouldn't change but values would shift unpredictably.

Build a minimal GenerationContext with `chronicityLevel: 'Chronic'`, `severityLevel: 'moderate to severe'`, `painCurrent: 8`, no `previousIE` (forces ltFallback path).

Run tests — they MUST fail (chronicDampener doesn't exist yet).
  </action>
  <verify>`npx vitest run src/generator/tx-sequence-engine-chronic.test.ts` — tests fail because chronic dampener logic doesn't exist</verify>
  <done>Test file exists with 5 test cases covering dampener activation, ltFallback alignment, and PRNG safety, all failing</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement chronic dampener and ltFallback alignment in engine</name>
  <files>src/generator/tx-sequence-engine.ts</files>
  <action>
**CRITICAL CONSTRAINT: NO new rng() calls inside the for-loop. All changes are deterministic calculations BEFORE the loop.**

**Change 1 — Chronic dampener on progressMultiplier (after L641, before L644):**

After the existing line:
```typescript
const progressMultiplier = inferProgressMultiplier(medHistory, context.age)
```

Replace with:
```typescript
const baseMultiplier = inferProgressMultiplier(medHistory, context.age)
// CRV-01: chronic-aware dampener — slower progression for long treatment courses
const chronicDampener = txCount >= 16 ? 0.82 : 1.0
const progressMultiplier = baseMultiplier * chronicDampener
```

This renames the original to `baseMultiplier` and applies the dampener. The variable `progressMultiplier` is still used at L736 unchanged.

**Change 2 — Chronic-aware ltFallback (L625-627):**

Replace the existing ltFallback calculation:
```typescript
const ltFallback = ieStartPain <= 6
  ? 1
  : Math.ceil(Math.max(2, ieStartPain * 0.25))
```

With:
```typescript
const chronicEndRatio = txCount >= 16 ? 0.55 : 0.25
const ltFallback = ieStartPain <= 6
  ? 1
  : Math.ceil(Math.max(2, ieStartPain * chronicEndRatio))
```

This ensures the engine's fallback LT target aligns with the goals calculator's chronic caps (both use 0.55 for chronic).

**Verification after implementation:**
- Confirm NO new `rng()` calls were added inside the `for` loop (L729+)
- Confirm `progressMultiplier` variable name is unchanged at its usage site (L736)
- Confirm `ltFallback` variable name is unchanged at its usage site (L632-634)
  </action>
  <verify>`npx vitest run src/generator/tx-sequence-engine-chronic.test.ts` — all tests pass. `npx tsc --noEmit` — zero type errors. `grep -c 'rng()' src/generator/tx-sequence-engine.ts` — count unchanged from before (no new rng calls added).</verify>
  <done>Chronic dampener (0.82) applied for txCount ≥ 16. ltFallback uses 0.55 ratio for chronic. Zero new rng() calls. All tests pass.</done>
</task>

</tasks>

<verification>
- `npx vitest run src/generator/tx-sequence-engine-chronic.test.ts` — all chronic dampener tests pass
- `npx tsc --noEmit` — zero TypeScript errors
- `grep -c 'rng()' src/generator/tx-sequence-engine.ts` — same count as before changes (no new rng calls in loop)
- Verify chronic dampener is BEFORE the for-loop, not inside it
</verification>

<success_criteria>
- txCount ≥ 16 → progressMultiplier dampened by 0.82
- txCount < 16 → progressMultiplier unchanged
- ltFallback uses chronicEndRatio (0.55) for txCount ≥ 16, (0.25) otherwise
- Zero new rng() calls inside the for-loop
- All unit tests pass
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-recovery-curve-goals-calibration/13-02-SUMMARY.md`
</output>
