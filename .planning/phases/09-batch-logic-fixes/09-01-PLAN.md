---
phase: 09-batch-logic-fixes
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/services/excel-parser.ts
  - server/__tests__/excel-parser.test.ts
autonomous: true
requirements: [BL-01, BL-02, BL-03]

must_haves:
  truths:
    - "soap-only mode defaults includeIE to true (same as full)"
    - "continue mode defaults includeIE to false"
    - "full mode IE visit gets TX CPT + 99203 for HF/VC insurance"
    - "soap-only mode IE visit gets TX CPT only (no 99203)"
    - "TX visits filter out 99203 in all modes"
    - "soap-only with includeIE=true requires ICD codes (existing validation)"
  artifacts:
    - path: "server/services/excel-parser.ts"
      provides: "parseIncludeIE fix + IE CPT mode-aware logic"
      contains: "getDefaultIECPT"
    - path: "server/__tests__/excel-parser.test.ts"
      provides: "Tests for all three BL requirements"
  key_links:
    - from: "server/services/excel-parser.ts"
      to: "src/shared/cpt-catalog.ts"
      via: "import getDefaultIECPT"
      pattern: "getDefaultIECPT\\(insurance\\)"
---

<objective>
Fix IE/CPT batch logic across three modes: change `parseIncludeIE` default for soap-only, wire `getDefaultIECPT` for mode-aware IE CPT construction, and verify ICD validation holds.

Purpose: Correct IE visit generation so full mode gets 99203 for HF/VC, soap-only does not, and continue mode never generates IE visits.
Output: Updated excel-parser.ts with passing tests covering all three requirements.
</objective>

<execution_context>
@/Users/ping/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ping/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-batch-logic-fixes/09-RESEARCH.md
@server/services/excel-parser.ts
@server/__tests__/excel-parser.test.ts
@src/shared/cpt-catalog.ts
</context>

<feature>
  <name>IE/CPT mode-aware logic</name>
  <files>server/services/excel-parser.ts, server/__tests__/excel-parser.test.ts</files>
  <behavior>
    BL-01 — parseIncludeIE defaults:
    - parseIncludeIE(undefined, 'full') -> true
    - parseIncludeIE(undefined, 'soap-only') -> true  (CHANGED from false)
    - parseIncludeIE(undefined, 'continue') -> false
    - Explicit true/false overrides still work in all modes

    BL-02 — IE CPT by mode:
    - Full mode, HF insurance, no user CPT -> IE gets [...getDefaultTXCPT('HF'), ...getDefaultIECPT('HF')] (includes 99203)
    - Full mode, OPTUM insurance, no user CPT -> IE gets [...getDefaultTXCPT('OPTUM')] (no 99203, OPTUM not in IE map)
    - Soap-only mode, HF insurance, no user CPT -> IE gets [...getDefaultTXCPT('HF')] (no 99203)
    - Full mode, user CPT "97810,99203" -> IE gets [97810, 99203] (user-specified 99203 kept only in full)
    - Soap-only mode, user CPT "97810,99203" -> IE gets [97810] (99203 stripped)
    - TX visits: always filter 99203 (already works, verify no regression)

    BL-03 — ICD validation:
    - soap-only mode, no explicit includeIE, no ICD -> throws "ICD codes are required" (because default flipped to true)
    - soap-only mode, includeIE=false, no ICD -> passes (explicit override)
  </behavior>
  <implementation>
    1. Add `getDefaultIECPT` import to excel-parser.ts (line 11, alongside existing cpt-catalog imports)

    2. Fix `parseIncludeIE` (line 119): change `return fallbackMode === 'full'` to `return fallbackMode !== 'continue'`

    3. Fix IE CPT block (lines 427-429 in buildPatientsFromRows):
       ```
       const baseCPT: CPTWithUnits[] = row.cpt.trim()
         ? parseCPTString(row.cpt).filter(c => c.code !== '99203')
         : [...getDefaultTXCPT(insurance)]
       const ieCPT: CPTWithUnits[] = rowMode === 'full'
         ? [...baseCPT, ...getDefaultIECPT(insurance)]
         : baseCPT
       ```

    4. Update tests: add cases for BL-01 defaults, BL-02 mode-aware CPT, BL-03 ICD validation with new defaults.
  </implementation>
</feature>

<verification>
- `npx vitest run server/__tests__/excel-parser.test.ts` — all tests pass
- `npx tsc --noEmit` — no type errors
- Existing tests still pass (no regression)
</verification>

<success_criteria>
- parseIncludeIE returns true for both full and soap-only when no explicit value
- parseIncludeIE returns false for continue mode
- Full mode IE visit CPT includes 99203 for HF/VC insurance
- Soap-only mode IE visit CPT excludes 99203
- TX visits never include 99203
- ICD required when includeIE=true regardless of mode
</success_criteria>

<output>
After completion, create `.planning/phases/09-batch-logic-fixes/09-01-SUMMARY.md`
</output>
